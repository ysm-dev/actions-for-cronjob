<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>기록은 재산이다</title>
  
  <subtitle>To Improve Human Life</subtitle>
  <link href="/feed.xml" rel="self"/>
  
  <link href="https://supawer0728.github.io/"/>
  <updated>2019-04-08T05:41:46.000Z</updated>
  <id>https://supawer0728.github.io/</id>
  
  <author>
    <name>supawer0728</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>(Spring Boot)오류 처리에 대해</title>
    <link href="https://supawer0728.github.io/2019/04/04/spring-error-handling/"/>
    <id>https://supawer0728.github.io/2019/04/04/spring-error-handling/</id>
    <published>2019-04-04T07:07:41.000Z</published>
    <updated>2019-04-08T05:41:46.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>오류 처리는 어플리케이션 개발에 있어 매우 큰 부분을 차지한다.<br>오류를 예측하는 것과 예방하는 것, 그리고 <code>오류를 빨리 발견하고 고칠 수 있는 것</code>은 훌륭한 개발자의 필수조건이라고 생각한다.<br>본 문서에서는 Spring에서 어떻게 예외처리 잘 할 수 있도록 도와주는지를 알아보고 공유하려한다.</p><a id="more"></a><h1 id="ErrorController"><a href="#ErrorController" class="headerlink" title="ErrorController"></a>ErrorController</h1><p>먼저 아래 Spring Boot에서 기본적으로 오류처리를 어떻게 해주는지 살펴보자.<br>아래는 404 Not Found에 대해서 html, json 응답 예제이다.</p><p><strong>GET /123</strong></p><p><img src="notfound.png" alt="image.png"></p><p><strong>GET /123 - json 응답</strong></p><ul><li>Content-Type: application/json</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"timestamp"</span>: <span class="string">"2019-02-15T21:48:44.447+0000"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="number">404</span>,</span><br><span class="line">  <span class="attr">"error"</span>: <span class="string">"Not Found"</span>,</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"No message available"</span>,</span><br><span class="line">  <span class="attr">"path"</span>: <span class="string">"/123"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위에서 살펴본 것과 같이 별다른 설정 없이 spring boot에서 웹 어플리케이션을 실행하면 기본적으로 오류 처리가 되고 있음을 알 수 있다.<br>그렇다면 어떠한 설정으로 spring boot에서 오류를 처리하는지 먼저 spring boot의 오류 처리에 대한 properties를 살펴보자.</p><p><strong>Spring Boot의 기본 오류 처리 properties</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># spring boot의 기본 properties</span></span><br><span class="line"><span class="string">server.error:</span></span><br><span class="line"><span class="attr">  include-exception:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  include-stacktrace:</span> <span class="string">never</span> <span class="comment"># 오류 응답에 stacktrace 내용을 포함할 지 여부</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">'/error'</span> <span class="comment"># 오류 응답을 처리할 Handler의 경로</span></span><br><span class="line">  <span class="string">whitelabel.enabled:</span> <span class="literal">true</span> <span class="comment"># 서버 오류 발생시 브라우저에 보여줄 기본 페이지 생성 여부</span></span><br></pre></td></tr></table></figure><ul><li><code>server.error.include-exception</code> : 응답에 exception의 내용을 포함할지 여부</li><li><code>server.error.include-stacktrace</code> : 응답에 stacktrace 내용을 포함할지 여부</li><li><code>server.error.path</code> : 오류 응답을 처리할 핸들러(ErrorController)의 path</li><li><code>server.error.whitelabel.enabled</code> : 브라우저 요청에 대해 서버 오류시 기본으로 노출할 페이지를 사용할지 여부</li></ul><p><code>server.error.whitelabel.enabled</code>의 기본값이 <code>true</code>이기 때문에 위에서와 같이 오류 페이지가 노출되고 있었다<br>아래 스크린샷은 <code>include-exception</code>과 <code>include-stacktrace</code>를 활성화하면 아래와 같이 응답을 받을 수 있다.</p><p><strong>HTML 응답</strong></p><p><img src="error-html.png" alt="errorhtml"></p><p><strong>json 응답</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"timestamp"</span>: <span class="string">"2019-04-04T09:31:27.931+0000"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="number">500</span>,</span><br><span class="line">  <span class="attr">"error"</span>: <span class="string">"Internal Server Error"</span>,</span><br><span class="line">  <span class="attr">"exception"</span>: <span class="string">"java.lang.IllegalStateException"</span>,</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"test"</span>,</span><br><span class="line">  <span class="attr">"trace"</span>: <span class="string">"java.lang.IllegalStateException: test ...(길어서 줄임)"</span>,</span><br><span class="line">  <span class="attr">"path"</span>: <span class="string">"/rest-test"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Spring-Boot의-기본-오류-처리-BasicErrorController"><a href="#Spring-Boot의-기본-오류-처리-BasicErrorController" class="headerlink" title="Spring Boot의 기본 오류 처리 - BasicErrorController"></a>Spring Boot의 기본 오류 처리 - BasicErrorController</h2><p>그렇다면 Spring Boot에서는 어떻게 이런 기본 처리를 하고 있는 것일까.<br>Spring Boot는 오류가 발생하면 <code>server.error.path</code>에 설정된 경로에서 요청을 처리하게 한다.<br>Spring Boot에서는 기본적으로 BasicErrorController가 등록이 되어 해당 요청을 처리하게 된다.<br>BasicErrorController는 대략적으로 아래와 같이 구현되어 있다.<br>전반적으로 소스코드를 모두 읽어보면 좋겠지만 주요한 곳에 번호를 붙여 아래에 설명을 달아두었다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"$&#123;server.error.path:$&#123;error.path:/error&#125;&#125;"</span>) <span class="comment">// 1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicErrorController</span> <span class="keyword">extends</span> <span class="title">AbstractErrorController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getErrorPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.errorProperties.getPath();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RequestMapping</span>(produces = MediaType.TEXT_HTML_VALUE) <span class="comment">// 2)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">errorHtml</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">            </span><br><span class="line">    HttpStatus status = getStatus(request);</span><br><span class="line">    Map&lt;String, Object&gt; model =</span><br><span class="line">      getErrorAttributes(request, isIncludeStackTrace(request, MediaType.TEXT_HTML)));</span><br><span class="line"></span><br><span class="line">    response.setStatus(status.value());</span><br><span class="line">    ModelAndView modelAndView = resolveErrorView(request, response, status, model);</span><br><span class="line">    <span class="keyword">return</span> (modelAndView != <span class="keyword">null</span>) ? modelAndView : <span class="keyword">new</span> ModelAndView(<span class="string">"error"</span>, model);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RequestMapping</span> <span class="comment">// 3)</span></span><br><span class="line">  <span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; error(HttpServletRequest request) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4)</span></span><br><span class="line">    Map&lt;String, Object&gt; body =</span><br><span class="line">      getErrorAttributes(request, isIncludeStackTrace(request, MediaType.ALL));</span><br><span class="line">    HttpStatus status = getStatus(request);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(body, status);</span><br><span class="line">  &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>Spring 환경 내에 <code>server.error.path</code> 혹은 <code>error.path</code>로 등록된 property의 값을 넣거나, 없는 경우 <code>/error</code>를 사용한다.</li><li>HTML로 응답을 주는 경우 <code>errorHtml</code>에서 응답을 처리한다.</li><li>HTML 외의 응답이 필요한 경우 <code>error</code>에서 처리한다.</li><li>실질적으로 view에 보낼 model을 생성한다</li></ol><blockquote><p><strong>BasicErrorController 정리</strong><br><code>BasicErrorController</code>에서는 HTML 요청, 그 외의 요청을 나누어서 처리할 핸들러를 등록하고 <code>getErrorAttributes</code>를 통해 응답을 위한 모델을 생성한다.</p></blockquote><h2 id="Spring-Boot의-기본-오류-처리-AbstractErrorController와-ErrorAttributes"><a href="#Spring-Boot의-기본-오류-처리-AbstractErrorController와-ErrorAttributes" class="headerlink" title="Spring Boot의 기본 오류 처리 - AbstractErrorController와 ErrorAttributes"></a>Spring Boot의 기본 오류 처리 - AbstractErrorController와 ErrorAttributes</h2><p><code>getErrorAttributes</code>를 조금 더 깊게 살펴보자.<br><code>getErrorAttributes</code>는 <code>BasicErrorController</code>의 상위 클래스인 <code>AbstractErrorController</code>에 구현되어 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractErrorController</span> <span class="keyword">implements</span> <span class="title">ErrorController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ErrorAttributes errorAttributes;</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> Map&lt;String, Object&gt; <span class="title">getErrorAttributes</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> includeStackTrace)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    WebRequest webRequest = <span class="keyword">new</span> ServletWebRequest(request);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.errorAttributes.getErrorAttributes(webRequest, includeStackTrace);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>구현된 내용을 보면 <code>ErrorAttributes</code> 인터페이스의 <code>getErrorAttributes</code>를 호출하는 것을 알 수 있다.(위임자 패턴)<br>별도로 <code>ErrorAttributes</code>를 등록하지 않았다면 Spring Boot는 <code>DefaultErrorAttributes</code>를 사용한다.<br>아래는 <code>DefaultErrorAttributes</code>의 일부 내용이다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ErrorAttributes</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 요청을 기반으로 모델을 생성</span></span><br><span class="line"><span class="function">Map&lt;String, Object&gt; <span class="title">getErrorAttributes</span><span class="params">(WebRequest webRequest, <span class="keyword">boolean</span> includeStackTrace)</span></span>;</span><br><span class="line">  <span class="comment">// 요청에서 Throwable을 획득</span></span><br><span class="line"><span class="function">Throwable <span class="title">getError</span><span class="params">(WebRequest webRequest)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> DefaultErrorAttributes &#123;</span><br><span class="line">  <span class="comment">// 생성자 및 메서드</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getErrorAttributes</span><span class="params">(WebRequest request, <span class="keyword">boolean</span> includeStackTrace)</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; errorAttributes = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    errorAttributes.put(<span class="string">"timestamp"</span>, <span class="keyword">new</span> Date()); <span class="comment">// timestamp 생성</span></span><br><span class="line">    addStatus(errorAttributes, request); <span class="comment">// status 생성</span></span><br><span class="line">    addErrorDetails(errorAttributes, request, includeStackTrace); <span class="comment">// 오류 상세 내용</span></span><br><span class="line">    addPath(errorAttributes, request); <span class="comment">// path 생성</span></span><br><span class="line">    <span class="keyword">return</span> errorAttributes;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ErrorAttributes에서 가져온 모델로 응답을 생성</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"timestamp"</span>: <span class="string">"2019-02-15T21:48:44.447+0000"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="number">404</span>,</span><br><span class="line">  <span class="attr">"error"</span>: <span class="string">"Not Found"</span>,</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"No message available"</span>,</span><br><span class="line">  <span class="attr">"path"</span>: <span class="string">"/123"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="확장-포인트-ErrorAttributes"><a href="#확장-포인트-ErrorAttributes" class="headerlink" title="확장 포인트 - ErrorAttributes"></a>확장 포인트 - ErrorAttributes</h2><p>위에서 살펴봤듯이 <code>ErrorAttributes</code>에서는 오류가 발생했을 때 응답을 내려줄 모델을 생성하고 있다.<br>여기서 우리는 <code>ErrorAttributes</code> 인터페이스를 마음껏 구현할 수 있다. Spring에서 제공하는 확장 포인트인 것이다.<br>개발자가 <code>ErrorAttributes</code>를 구현하여 bean으로 등록하면 <code>BasicErrorController</code>는 해당 <code>ErrorAttributes</code>를 사용한다.<br>아래는 임의로 모델에 <code>&quot;greeting&quot;: &quot;Hello&quot;</code>를 추가한 예제이다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomErrorAttributes</span> <span class="keyword">extends</span> <span class="title">DefaultErrorAttributes</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getErrorAttributes</span><span class="params">(WebRequest webRequest, <span class="keyword">boolean</span> includeStackTrace)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">super</span>.getErrorAttributes(webRequest, includeStackTrace);</span><br><span class="line">        result.put(<span class="string">"greeting"</span>, <span class="string">"Hello"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>응답 예제</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"timestamp"</span>: <span class="string">"2019-02-15T22:24:41.275+0000"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="number">404</span>,</span><br><span class="line">  <span class="attr">"error"</span>: <span class="string">"Not Found"</span>,</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"No message available"</span>,</span><br><span class="line">  <span class="attr">"path"</span>: <span class="string">"/123"</span>,</span><br><span class="line">  <span class="attr">"greeting"</span>: <span class="string">"Hello"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="HTML-View-연계-404-html-4xx-html"><a href="#HTML-View-연계-404-html-4xx-html" class="headerlink" title="HTML View 연계 - 404.html, 4xx.html"></a>HTML View 연계 - 404.html, 4xx.html</h2><p>본 문서에서는 View Template Engine으로 <a href="https://mustache.github.io/" target="_blank" rel="noopener">Mustache</a>를 사용했다.<br>이 경우 Spring은 view를 <code>src/main/resources/templates</code> 하위 경로에서 찾는다.(View Template Engine 구현에 따라 다를 수 있다)<br>이 때 기본 경로 하위에 <code>/error/{응답코드}</code>로 view의 이름을 작성하는 경우<br><code>ErrorController</code>에서 응답 코드에 맞게 해당 view로 응답을 내려줄 수 있다.</p><blockquote><p>본 문서에서는 HTML view의 접미사(suffix)를 <code>.html</code>로 사용했다</p></blockquote><p><strong>src/main/resources<code>/templates/error/404.html</code> 작성</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>404오류<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">timestamp: &#123;&#123;timestamp&#125;&#125;</span><br><span class="line">error: &#123;&#123;error&#125;&#125;</span><br><span class="line">message: &#123;&#123;message&#125;&#125;</span><br><span class="line">path: &#123;&#123;path&#125;&#125;</span><br><span class="line">greeting: &#123;&#123;greeting&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>위와 같이 응답코드로 view 이름을 작성한 경우 404 응답은 위 view로 응답이 처리된다.<br>더 넓게 <code>4xx.html</code>과 같은 명명으로 400번 대의 응답코드를 모두 처리할 수도 있다.</p><h2 id="View를-가져오는-방법-TemplateAvailabilityProvider"><a href="#View를-가져오는-방법-TemplateAvailabilityProvider" class="headerlink" title="View를 가져오는 방법 - TemplateAvailabilityProvider"></a>View를 가져오는 방법 - TemplateAvailabilityProvider</h2><p>Spring은 어떻게 위와 같은 방식으로 view를 가져왔을까.<br>이는 <code>TemplateAvailablityProvider</code>로 구현되어 있다.<br><code>TemplateAvailabilityProvider</code> 인터페이스의 <code>isTemplateAvailable()</code>을 호출하여 view를 resolve할 수 있는지 여부를 파악한다.<br>현재 프로젝트에 쓰인 Mustache에 대해서는 <code>MustacheTemplateAvailabilityProvider</code> 구현체가 동작한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MustacheTemplateAvailabilityProvider</span> <span class="keyword">implements</span> <span class="title">TemplateAvailabilityProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTemplateAvailable</span><span class="params">(String view Environment environment,</span></span></span><br><span class="line"><span class="function"><span class="params">      ClassLoader classLoader, ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    String prefix = environment.getProperty(<span class="string">"spring.mustache.prefix"</span>, DEFAULT_PREFIX); <span class="comment">// 1)</span></span><br><span class="line">    String suffix = environment.getProperty(<span class="string">"spring.mustache.suffix"</span>, DEFAULT_SUFFIX); <span class="comment">// 2)</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> resourceLoader.getResource(prefix + view + suffix).exists(); <span class="comment">// 3)</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><code>spring.mustache.prefix</code>의 기본값 “classpath:/templates/“</li><li><code>spring.mustache.suffix</code>는 <code>.html</code>로 설정</li><li>view는 <code>error/{응답코드}</code>가 들어간다</li></ol><blockquote><p>view를 resolve하기 위해 <code>classpath:/templates/error/404.html</code>이 호출된다</p></blockquote><h2 id="확장-포인트-BasicErrorController"><a href="#확장-포인트-BasicErrorController" class="headerlink" title="확장 포인트 - BasicErrorController"></a>확장 포인트 - BasicErrorController</h2><p><code>ErrorAttributes</code>와 마찬가지로 <code>ErrorController</code>의 구현체를 개발자가 bean으로 등록한다면<br>Spring Boot는 해당 빈을 먼저 찾아 <code>BasicErrorController</code> 대신 오류 처리를 위해 사용하게 된다.<br>위임자 패턴을 사용해서 기본적인 처리는 <code>BasicErrorController</code>에게 위임하고, 나머지 필요한 처리를 추가할 수 있다.<br>아래 소스에서는 로그를 추가해보았다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"$&#123;server.error.path:$&#123;error.path:/error&#125;&#125;"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomErrorController</span> <span class="keyword">extends</span> <span class="title">BasicErrorController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomErrorController</span><span class="params">(ErrorAttributes errorAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 ServerProperties serverProperties,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 List&lt;ErrorViewResolver&gt; errorViewResolvers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(errorAttributes, serverProperties.getError(), errorViewResolvers);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(produces = MediaType.TEXT_HTML_VALUE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">errorHtml</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        log(request); <span class="comment">// 로그 추가</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.errorHtml(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; error(HttpServletRequest request) &#123;</span><br><span class="line">        log(request);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.error(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        log.error(<span class="string">"error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="spring-webflux에서는"><a href="#spring-webflux에서는" class="headerlink" title="spring-webflux에서는?"></a>spring-webflux에서는?</h2><p>여태까지는 <code>spring-mvc</code> 모듈을 통해 지원되는 내용이었다.<br>SpringFramework 5에 추가된 <code>spring-webflux</code>에서도 <code>spring-mvc</code>와의 로직에 대한 대칭성을 유지하는 클래스들이 있다.</p><table><thead><tr><th>설명</th><th>spring-mvc</th><th>spring-webflux</th></tr></thead><tbody><tr><td>인터페이스</td><td>ErrorController</td><td>ErrorWebExceptionHandler extends WebExceptionHandler</td></tr><tr><td>편의를 위해 추상화된 클래스</td><td>AbstractErrorController</td><td>AbstractErrorWebExceptionHandler</td></tr><tr><td>기본 Bean으로 제공되는 클래스</td><td>BasicErrorController</td><td>DefaultErrorWebExceptionHandler</td></tr></tbody></table><p><code>spring-mvc</code>와 마찬가지로 <code>ErrorAttributes</code>를 확장해서 사용할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultErrorWebExceptionHandler</span> <span class="keyword">extends</span> <span class="title">AbstractErrorWebExceptionHandler</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> RouterFunction&lt;ServerResponse&gt; <span class="title">getRoutingFunction</span><span class="params">(ErrorAttributes errorAttributes)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RouterFunctions.route(<span class="keyword">this</span>.acceptsTextHtml(), <span class="keyword">this</span>::renderErrorView)</span><br><span class="line">                          .andRoute(RequestPredicates.all(), <span class="keyword">this</span>::renderErrorResponse);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ErrorController에-대한-추가-설명"><a href="#ErrorController에-대한-추가-설명" class="headerlink" title="ErrorController에 대한 추가 설명"></a>ErrorController에 대한 추가 설명</h2><p><code>ErrorController</code>가 호출되기까지의 흐름을 설명하자면 다음과 같다.</p><ol><li>서블릿 컨테이너(ex: 톰캣)에서 등록된 서블릿에서 요청을 처리하다가</li><li>오류가 발생했는데</li><li>해당 서블릿에서 처리하지 못하고</li><li>서블릿 컨테이너까지 오류가 전파되었을 때, 서블릿 컨테이너가 오류를 처리하기 위해 특정 경로(<code>server.error.path</code>)로 해당 요청처리를 위임할 때 사용된다.</li></ol><img src="http://www.plantuml.com/plantuml/svg/YmvEBIhBIIrHSCxFAqdCp4ijYbNGrRLJY8QAnofOAHZgARoPDUNDfhKARpRDUBriZKQ2Vaf-WYONGerkQG6I7cIph1ICWBfdB7czT8R2wmrptZJFrKY0AdEjI4ujACdCpqCo2fypZE46GPm1TPI6kdvgKL5-aRec0000"><h1 id="spring-mvc-Exception-기반으로-오류-처리"><a href="#spring-mvc-Exception-기반으로-오류-처리" class="headerlink" title="spring-mvc Exception 기반으로 오류 처리"></a>spring-mvc Exception 기반으로 오류 처리</h1><p>앞의 추가 설명에서 봤듯이 <code>ErrorController</code>가 동작하는 것은 요청을 처리해야할 Servlet에서 오류가 발생했으나 해당 Servlet에서 오류를 처리하지 않아서 Servlet Container까지 오류가 전파되었을 때(<code>ServletException</code>으로 래핑된다), Servlet Container가 <code>ErrorController</code>를 호출한다. 이 때, 필자가 테스트한 Servlet Container(Tomcat 9.0.17)에서는 아래와 같은 로그를 남긴다</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2019-04-04 18:31:27.915 ERROR 21947 --- [nio-8080-exec-1] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.IllegalStateException: test] with root cause</span><br></pre></td></tr></table></figure><p>해당 로그는 Servlet Container에서 남기고 있는 것으로, 개발자가 사용자화 하기 어려운 부분이다.<br>logging framework(log4j, logback) 등으로 해당 로그를 남기지 않거나 할 수는 있지만,<br>로그 내요을 변경하거나 하기는 어렵다는 것이다.</p><p>Spring에서는 Handler(Controller의 <code>@RequestMapping</code>이 걸린 메서드)에서 처리하다 Exception이 발생한 경우, 이를 Servlet Container까지 전파하지 않고, 직접 Exception 별로 처리를 할 수 있도록 해준다. Spring에서 Exception 기반으로 오류를 처리하는 방법을 알아보자.</p><h2 id="ExceptionHandler"><a href="#ExceptionHandler" class="headerlink" title="@ExceptionHandler"></a>@ExceptionHandler</h2><p>Spring에서는 발생한 Exception을 기반으로 오류를 처리할 수 있도록 <code>@ExceptionHandler</code>를 제공한다.</p><p><strong>예외를 던지도록 소스 추가</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/boards"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Board <span class="title">get</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (id &lt; <span class="number">1L</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BoardNotFoundException(<span class="string">"invalid id: "</span> + id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Board(<span class="string">"title"</span>, <span class="string">"content"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ResponseStatus</span>(HttpStatus.NOT_FOUND)</span><br><span class="line">  <span class="meta">@ExceptionHandler</span>(BoardNotFoundException.class)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">handle</span><span class="params">(BoardNotFoundException e)</span> </span>&#123;</span><br><span class="line">      log.error(e.getMessage(), e);</span><br><span class="line">      Map&lt;String, String&gt; errorAttributes = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">      errorAttributes.put(<span class="string">"code"</span>, <span class="string">"BOARD_NOT_FOUND"</span>);</span><br><span class="line">      errorAttributes.put(<span class="string">"message"</span>, e.getMessage());</span><br><span class="line">      <span class="keyword">return</span> errorAttribute;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위와 같이 특정 Controller에서 예외가 발생한 경우, Spring은 <code>@ExceptionHandler</code>를 검색하여<br>해당 애너테이션에 선언된 예외 및 하위 예외에 대해서 특정 메서드가 처리할 수 있도록 한다.<br>또한 보통의 핸들러와 마찬가지로 <code>@ResponseStatus</code>를 통해 응답 코드를 정의하거나,<br><code>ModelAndView</code>, <code>String</code>을 반환하여 view를 resolve할 수 있고, <code>ResponseEntity&lt;T&gt;</code>를 반환할 수도 있다.</p><p>이제 오류가 발생하도록 요청을 보내보자.</p><p><strong>실행</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 404</span><br><span class="line">Content-Type: application/json;charset=UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Sun, 17 Feb 2019 04:31:33 GMT</span><br><span class="line"></span><br><span class="line">&#123;&quot;code&quot;:&quot;BOARD_NOT_FOUND&quot;,&quot;message&quot;:&quot;invalid id: 0&quot;&#125;</span><br></pre></td></tr></table></figure><h2 id="ControllerAdvice"><a href="#ControllerAdvice" class="headerlink" title="ControllerAdvice"></a>ControllerAdvice</h2><p>Spring에서는 Bean으로 등록되는 <code>@Controller</code>들을 선택적으로, 혹은 전역으로 몇가지 공통 설정을 적용할 수 있도록 <code>@ControllerAdvice</code>를 사용할 수 있다<br>이 <code>@ControllerAdvice</code>에서 사용할 수 있는 것 중 하나가 <code>@ExceptionHandler</code>다</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalControllerAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ResponseStatus</span>(HttpStatus.NOT_FOUND)</span><br><span class="line">  <span class="meta">@ExceptionHandler</span>(BoardNotFoundException.class)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">handle</span><span class="params">(BoardNotFoundException e, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (JSON_응답해야하는지(request)) &#123;</span><br><span class="line">      <span class="keyword">return</span> makeJson(e);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"/error/404"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ControllerAdvice-나누기"><a href="#ControllerAdvice-나누기" class="headerlink" title="ControllerAdvice 나누기"></a>ControllerAdvice 나누기</h2><p>앞의 예제에서는 하나의 method에서 JSON응답과 HTML응답을 해야하는 경우를 나누고 있었다.<br>HTML view를 사용할 경우와 json view를 사용할 경우를 나누어 <code>ControllerAdivce</code>를 등록하고,<br><code>@Order</code>를 사용하여 우선 순위를 부여하면 분기처리 없이 나누어 오류 처리를 할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Order</span>(ORDER)</span><br><span class="line"><span class="meta">@RestControllerAdvice</span>(annotations = RestController.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalRestControllerAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ORDER = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseStatus</span>(HttpStatus.NOT_FOUND)</span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(BoardNotFoundException.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">handle</span><span class="params">(BoardNotFoundException e)</span> </span>&#123;</span><br><span class="line">        log.error(e.getMessage(), e);</span><br><span class="line">        Map&lt;String, String&gt; errorAttributes = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        errorAttributes.put(<span class="string">"code"</span>, <span class="string">"BOARD_NOT_FOUND"</span>);</span><br><span class="line">        errorAttributes.put(<span class="string">"message"</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> errorAttributes;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Order</span>(GlobalRestControllerAdvice.ORDER + <span class="number">1</span>)</span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalHtmlControllerAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseStatus</span>(HttpStatus.NOT_FOUND)</span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(BoardNotFoundException.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handle</span><span class="params">(BoardNotFoundException e, Model model, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        log.error(e.getMessage(), e);</span><br><span class="line">        model.addAttribute(<span class="string">"timestamp"</span>, LocalDateTime.now());</span><br><span class="line">        model.addAttribute(<span class="string">"error"</span>, <span class="string">"BOARD_NOT_FOUND"</span>);</span><br><span class="line">        model.addAttribute(<span class="string">"path"</span>, request.getRequestURI());</span><br><span class="line">        model.addAttribute(<span class="string">"message"</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/error/404"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Spring-MVC에서-제공해주는-ResponseEntityExceptionHandler"><a href="#Spring-MVC에서-제공해주는-ResponseEntityExceptionHandler" class="headerlink" title="Spring MVC에서 제공해주는 ResponseEntityExceptionHandler"></a>Spring MVC에서 제공해주는 ResponseEntityExceptionHandler</h2><p><code>ControllerAdvice</code>를 사용하여 Exception 처리를 한 곳으로 모으는 경우, <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/servlet/mvc/method/annotation/ResponseEntityExceptionHandler.html" target="_blank" rel="noopener">ResponseEntityExceptionHandler</a>를 상속받도록 하여 Spring MVC에서 기본으로 제공되는 Exception들의 처리를 간단하게 등록할 수 있다. 각 Exception 처리를 위한 메서드들은 모두 <code>protected</code>로 선언되어 있으며, 하위 클래스에서 필요에 따라 Override할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseEntityExceptionHandler</span> </span>&#123;</span><br><span class="line">  <span class="meta">@ExceptionHandler</span>(&#123;</span><br><span class="line">    HttpRequestMethodNotSupportedException.class,</span><br><span class="line">    HttpMediaTypeNotSupportedException.class,</span><br><span class="line">    HttpMediaTypeNotAcceptableException.class,</span><br><span class="line">    MissingPathVariableException.class,</span><br><span class="line">    MissingServletRequestParameterException.class,</span><br><span class="line">    ServletRequestBindingException.class,</span><br><span class="line">    ConversionNotSupportedException.class,</span><br><span class="line">    TypeMismatchException.class,</span><br><span class="line">    HttpMessageNotReadableException.class,</span><br><span class="line">    HttpMessageNotWritableException.class,</span><br><span class="line">    MethodArgumentNotValidException.class,</span><br><span class="line">    MissingServletRequestPartException.class,</span><br><span class="line">    BindException.class,</span><br><span class="line">    NoHandlerFoundException.class,</span><br><span class="line">    AsyncRequestTimeoutException.class</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ResponseEntity&lt;Object&gt; <span class="title">handleException</span><span class="params">(Exception ex, WebRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 각 예외에 대한 분기처리 로직(상속 구현 가능하도록 protected로 메서드가 선언되어 있음)</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 각 예외 처리를 위한 protected 메서드들이 있음</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> ResponseEntity&lt;Object&gt; <span class="title">handleHttpRequestMethodNotSupported</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      HttpRequestMethodNotSupportedException ex, HttpHeaders headers, HttpStatus status, WebRequest request)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 예외 처리</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>각 Spring MVC Exception 설명</strong></p><table><thead><tr><th>Exception</th><th>설명</th><th>응답코드</th></tr></thead><tbody><tr><td>HttpRequestMethodNotSupportedException</td><td>요청 경로는 있으나 지원하지 않는 Method인 경우 발생</td><td>405 - Method Not Allowed</td></tr><tr><td>HttpMediaTypeNotSupportedException</td><td>요청의 Content Type을 핸들러가 지원하지 않는 경우 발생</td><td>415 - Unsupported Media Type</td></tr><tr><td>HttpMediaTypeNotAcceptableException</td><td>핸들러가 Client가 요청한 Type으로 응답을 내려줄 수 없는 경우 발생</td><td>406 - Not Acceptable</td></tr><tr><td>MissingPathVariableException</td><td>핸들러가 URL에서 기대한 Path Variable을 찾지 못한 경우 발생</td><td>500 - Internal Server Error</td></tr><tr><td>MissingServletRequestParameterException</td><td>핸들러가 기대한 요청 Parameter를 찾지 못한 경우 발생</td><td>400 - Bad Request</td></tr><tr><td>ServletRequestBindingException</td><td>복구 불가능한 치명적인 간주할 binding exception<br>Filter 등의 Servlet Resource에서 던지기 쉽도록 ServletException을 상속하고 있음</td><td>400 - Bad Request</td></tr><tr><td>ConversionNotSupportedException</td><td>bean property로 요청 내용을 변경하기 위한<br><code>editor</code> 혹은 <code>converter</code>를 찾지 못한 경우 발생</td><td>500 - Internal Server Error</td></tr><tr><td>TypeMismatchException</td><td>bean property로 값을 변경할 때, 핸들러가 예상한 class로 변경할 수 없는 경우 발생</td><td>400 - Bad Request</td></tr><tr><td>HttpMessageNotReadableException</td><td><code>HttpMessageConverter</code>에서 발생하며 <code>read</code> 메서드가 실패한 경우 발생</td><td>400 - Bad Request</td></tr><tr><td>HttpMessageNotWritableException</td><td><code>HttpMessageConverter</code>에서 발생하며 <code>write</code> 메서드가 실패한 경우 발생</td><td>500 - Internal Server Error</td></tr><tr><td>MethodArgumentNotValidException</td><td><code>@Valid</code>가 붙은 파라미터에 대해 검증 실패시 발생</td><td>400 - Bad Request</td></tr><tr><td>MissingServletRequestPartException</td><td><code>multipart/form-data</code> 요청의 일부가 손실(can’t be found)되었을 때 발생</td><td>400 - Bad Request</td></tr><tr><td>NoHandlerFoundException</td><td>Dispatcher Servlet에서 핸들러를 찾지 못한 경우 기본적으로 404 응답을 내리지만<br>Dispatcher Servlet의 <code>throwExceptionIfNoHandlerFound</code> 값이 true인 경우 해당 예외를 발생</td><td>404 - Not Found</td></tr><tr><td>AsyncRequestTimeoutException</td><td>비동기 요청의 응답시간이 초과될 때 발생</td><td>503 - Service Unavailable</td></tr></tbody></table><h2 id="HandlerExceptionResolver"><a href="#HandlerExceptionResolver" class="headerlink" title="HandlerExceptionResolver"></a>HandlerExceptionResolver</h2><p>애너테이션 기반으로 동작하는 <code>@ExceptionHandler</code> 외에도 <code>HandlerExceptionResolver</code> 인터페이스를 사용할 수 있다.<br>이 인터페이스는 요청, 응답, 핸들러, 예외를 받아 <code>ModelAndView</code>를 반환값으로 하는 <code>resolveException</code> 메서드를 가지고 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerExceptionResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function">ModelAndView <span class="title">resolveException</span><span class="params">(HttpServletRequest req, HttpServletResponse res, Object handler, Exception ex)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="HandlerExceptionResolver-구현체"><a href="#HandlerExceptionResolver-구현체" class="headerlink" title="HandlerExceptionResolver 구현체"></a>HandlerExceptionResolver 구현체</h3><ul><li>ExceptionHandlerExceptionResolver : <code>@ExceptionHandler</code>가 붙은 메서드를 통해 예외 처리를 할 수 있도록 설정하는 클래스</li><li>SimpleMappingExceptionResolver : 예외 이름과 view 이름을 매핑해주며, browser 요청을 view로 렌더링할 때 유용하게 쓸 수 있다</li><li>ResponseStatusExceptionResolver : Exception 클래스에 <code>@ResponseStatus</code>를 달아 해당 응답 코드로 응답을 보낼 수 있도록 설정하는 클래스</li><li>DefaultHandlerExceptionResolver : Spring MVC Exception에 대해 기본적인 처리를 해주는 클래스</li></ul><h4 id="Exception에-응답코드-달기"><a href="#Exception에-응답코드-달기" class="headerlink" title="Exception에 응답코드 달기"></a>Exception에 응답코드 달기</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseStatus</span>(HttpStatus.NOT_FOUND)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">NotFoundException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardNotFoundException</span> <span class="keyword">extends</span> <span class="title">NotFoundException</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위와 같이 Exception에 <code>@ResponseStatus</code>가 붙어 있고, 해당 Exception이 발생하면<br>Spring에서는 해당 Response Code로 응답을 준다.</p><blockquote><p>이 경우 서비스 로직에서 사용할 Exception이 HTTP라고 하는 MVC 구현에 종속된다.<br>MVC Layer와 Service Layer의 커플링을 발생시키지 않도록 유의해야 한다.</p></blockquote><h3 id="사용자-정의-HandlerExceptionResolver-구현"><a href="#사용자-정의-HandlerExceptionResolver-구현" class="headerlink" title="사용자 정의 HandlerExceptionResolver 구현"></a>사용자 정의 HandlerExceptionResolver 구현</h3><h1 id="번외"><a href="#번외" class="headerlink" title="번외"></a>번외</h1><h2 id="Filter와-Interceptor"><a href="#Filter와-Interceptor" class="headerlink" title="Filter와 Interceptor"></a>Filter와 Interceptor</h2><p>Filter와 Interceptor는 실행되는 위치가 다르다.<br>때문에 Exception이 발생했을 때 처리하는 방법도 달라진다.</p><p>Interceptor는 DispatcherServlet 내부에서 발생하기 때문에 <code>ControllerAdvice</code>를 적용할 수 있다.<br>하지만 Filter는 DispatcherServlet 외부에서 발생해서 <code>ErrorController</code>에서 처리해야 한다.</p><p><img src="https://supawer0728.github.io/2018/04/04/spring-filter-interceptor/spring-request-lifecycle.jpg" alt="image"><br>이미지 출처: <a href="https://justforchangesake.files.wordpress.com/2014/05/spring-request-lifecycle.jpg" target="_blank" rel="noopener">https://justforchangesake.files.wordpress.com/2014/05/spring-request-lifecycle.jpg</a></p><h1 id="정리"><a href="#정리" class="headerlink" title="정리"></a>정리</h1><p>Spring에서 예외처리를 하는 방법에 대해 훑어보았다.<br>Spring MVC 내에서는 <code>@HandlerException</code>을 통해 각 <code>@Controller</code>별로 예외 처리를 할 수 있었으며,<br><code>@HandlerException</code>을 <code>@ControllerAdvice</code>에 등록하여 전역적으로 예외를 처리할 수도 있었다.<br>또한 브라우저 요청과 REST API의 요청을 나누어서 <code>@ControllerAdvice</code>에서 처리할 수 있다.<br>이러한 기본 동작들은 <code>HandlerExceptionResolver</code>에 의해 이루어진다.</p><p>Spring MVC 내에서 처리하지 못한 예외들은 <code>ServletException</code>으로 포장되어 서블릿 컨테이너까지 전파되며, 서블릿 컨테이너는 예외를 처리하기 위해나 경로로 예외 처리를 위임하게 된다. 이때 Spring boot를 기본설정으로 사용하는 경우, <code>BasicErrorController</code>가 이를 담당하게 된다.</p><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p>예외 처리에 대해 잘 이해하고, 이를 잘 해내는 것은 견고한 어플리케이션을 작성하기 위한 밑거름이 된다고 생각한다.<br>경험있는 개발자들은 예외를 미리 예측하고 방지할 수 있다. 하지만 이러한 경험을 잘 쌓기 위해서는 그동안 발생하는 예외에 대해서 파악하기 쉬워야 한다.<br>예외 처리를 잘 해낸다면 같은 오류가 발생해도 더 빠르게 인지하고, 문제점을 정확하게 짚어낼 수 있을 것이다.<br>어플리케이션 개발이 운영 국면에 들어서면 기능만 잘 뽑아내는 것보다 예외 탐지, 트러블슈팅, 장애 방지를 잘하는 것이 얼마나 가치있는 것인지 깨닫게 되는 것 같다.</p><h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><p>Spring framework reference </p><ul><li>mvc exceptions : <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-ann-exceptionhandler" target="_blank" rel="noopener">https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-ann-exceptionhandler</a></li><li>controller exceptions : <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-ann-exceptionhandler" target="_blank" rel="noopener">https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-ann-exceptionhandler</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;오류 처리는 어플리케이션 개발에 있어 매우 큰 부분을 차지한다.&lt;br&gt;오류를 예측하는 것과 예방하는 것, 그리고 &lt;code&gt;오류를 빨리 발견하고 고칠 수 있는 것&lt;/code&gt;은 훌륭한 개발자의 필수조건이라고 생각한다.&lt;br&gt;본 문서에서는 Spring에서 어떻게 예외처리 잘 할 수 있도록 도와주는지를 알아보고 공유하려한다.&lt;/p&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
      <category term="boot" scheme="https://supawer0728.github.io/categories/spring/boot/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="spring-boot" scheme="https://supawer0728.github.io/tags/spring-boot/"/>
    
      <category term="error" scheme="https://supawer0728.github.io/tags/error/"/>
    
      <category term="error-handling" scheme="https://supawer0728.github.io/tags/error-handling/"/>
    
  </entry>
  
  <entry>
    <title>(Spring Boot)Spring Boot Actuator 소개</title>
    <link href="https://supawer0728.github.io/2018/05/12/spring-actuator/"/>
    <id>https://supawer0728.github.io/2018/05/12/spring-actuator/</id>
    <published>2018-05-12T08:33:26.000Z</published>
    <updated>2018-09-03T09:30:38.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>웹 개발자로서 웹 애플리케이션을 만들 때 신경써야할 것은 서비스 로직 뿐만이 아니다. 웹 애플리케이션의 사용자는 누구인지(일반인? 외부시스템?), 어떤 경로로 애플리케이션에 요청을 할 지(Load Balancing, Fire Wall), 요청 수나 TPS 등 많은 것들을 고려해야한다. 이번에 소개할 <code>spring-boot-actuator</code>라는 모듈은 <strong>애플리케이션의 상태</strong>를 종합적으로 정리하여 우리에게 제공해준다. 본문에서는 <a href="https://github.com/spring-projects/spring-boot/tree/master/spring-boot-samples" target="_blank" rel="noopener">Spring Boot Samples</a>에 있는 프로젝트 중에서 <code>spring-boot-sample-actuator-ui</code>를 가져와 살짝 소스를 수정하여 actuator가 무엇이고 어떤 일 해주는지 알아보려한다.</p><a id="more"></a><h1 id="샘플-프로젝트로-Actuator-체험해보기"><a href="#샘플-프로젝트로-Actuator-체험해보기" class="headerlink" title="샘플 프로젝트로 Actuator 체험해보기"></a>샘플 프로젝트로 Actuator 체험해보기</h1><h2 id="소스-수정"><a href="#소스-수정" class="headerlink" title="소스 수정"></a>소스 수정</h2><p><a href="https://github.com/spring-projects/spring-boot/tree/master/spring-boot-samples/spring-boot-sample-actuator-ui" target="_blank" rel="noopener">spring-boot-sample-actuator-ui</a>에서 소스를 다운받아 <code>pom.xml</code> 파일의 <code>parent</code>를 수정하여 바로 실행해볼 수 있다. 여기서는 <code>sprint-boot-starter-security</code>도 제외시키겠다.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- parent를 spring-boot-starter-parent로 수정 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Your own application should inherit from spring-boot-starter-parent --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- spring-security 주석처리 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;dependency&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;/dependency&gt;--&gt;</span></span><br></pre></td></tr></table></figure><h2 id="applcation-properties"><a href="#applcation-properties" class="headerlink" title="applcation.properties"></a>applcation.properties</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring.security.user.name=user</span><br><span class="line">spring.security.user.password=password</span><br><span class="line">management.health.diskspace.enabled=false</span><br><span class="line">management.endpoints.web.exposure.include=*</span><br></pre></td></tr></table></figure><p>앞서 security 의존성을 없앴기 때문에 <code>spring-security</code>가 동작하지는 않는다.</p><h2 id="실행"><a href="#실행" class="headerlink" title="실행"></a>실행</h2><p>maven의 <code>spring-boot:run</code>이나 직접 <code>SampleActuatorUiApplication</code>의 <code>main()</code>을 호출하여 서버를 띄운 후 <code>GET /actuator</code>를 실행해보자. 아래와 같은 json 정보를 얻을 수 있다.(몇몇 부분은 생략했다) </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"_links"</span>:&#123;</span><br><span class="line">      <span class="attr">"self"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator"</span>&#125;,</span><br><span class="line">      <span class="attr">"auditevents"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/auditevents"</span>&#125;,</span><br><span class="line">      <span class="attr">"beans"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/beans"</span>&#125;,</span><br><span class="line">      <span class="attr">"health"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/health"</span>&#125;,</span><br><span class="line">      <span class="attr">"conditions"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/conditions"</span>&#125;,</span><br><span class="line">      <span class="attr">"configprops"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/configprops"</span>&#125;,</span><br><span class="line">      <span class="attr">"env"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/env"</span>&#125;,</span><br><span class="line">      <span class="attr">"env-toMatch"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/env/&#123;toMatch&#125;"</span>&#125;,</span><br><span class="line">      <span class="attr">"info"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/info"</span>&#125;,</span><br><span class="line">      <span class="attr">"loggers"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/loggers"</span>&#125;,</span><br><span class="line">      <span class="attr">"loggers-name"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/loggers/&#123;name&#125;"</span>&#125;,</span><br><span class="line">      <span class="attr">"heapdump"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/heapdump"</span>&#125;,</span><br><span class="line">      <span class="attr">"threaddump"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/threaddump"</span>&#125;,</span><br><span class="line">      <span class="attr">"metrics-requiredMetricName"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/metrics/&#123;requiredMetricName&#125;"</span>&#125;,</span><br><span class="line">      <span class="attr">"metrics"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/metrics"</span>&#125;,</span><br><span class="line">      <span class="attr">"scheduledtasks"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/scheduledtasks"</span>&#125;,</span><br><span class="line">      <span class="attr">"httptrace"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/httptrace"</span>&#125;,</span><br><span class="line">      <span class="attr">"mappings"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/mappings"</span>&#125;,</span><br><span class="line">      <span class="attr">"jolokia"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/jolokia"</span>&#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위와 같은 내용의 애플리케이션의 상태를 확인할 수 있다. 예를 들어 <code>GET /actuator/health</code>를 실행해보자. 아래와 같이 현재 애플리케이션의 health 상태를 알 수 있다.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"status"</span>: <span class="string">"UP"</span>&#125;</span><br></pre></td></tr></table></figure><p>혹은 <code>GET /actuator/metrics/jvm.threads.live</code>를 요청해보자. 현재 JVM의 활성화된 Thread의 정보를 가져올 수 있다.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;  </span><br><span class="line">   <span class="attr">"name"</span>:<span class="string">"jvm.threads.live"</span>,</span><br><span class="line">   <span class="attr">"measurements"</span>:[  </span><br><span class="line">      &#123;  </span><br><span class="line">         <span class="attr">"statistic"</span>:<span class="string">"VALUE"</span>,</span><br><span class="line">         <span class="attr">"value"</span>:<span class="number">23</span></span><br><span class="line">      &#125;</span><br><span class="line">   ],</span><br><span class="line">   <span class="attr">"availableTags"</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>GET /actuator/heapdump</code>나 <code>GET /actuator/threaddump</code>를 요청하면 dump 파일을 받을 수도 있다.</p><p>이러한 애플리케이션의 상태 정보를 아무에게나 노출하면 안될 것 같다. 확인된 사용자에게만 actuator 정보를 노출하고자 할 때에는 간단하게 두 가지 방법을 고려할 수 있다.</p><ol><li><code>management.server.port</code>, <code>management.server.address</code> 값을 수정해서 해당 ip, address에 한해 ACL를 걺</li><li><code>spring-security</code>를 이용하여 <code>management.endpoints.web.base-path(기본값 /actuator)</code>에 대해 권한을 확인</li></ol><p>물론 두 방법을 동시에 사용할 수도 있다.</p><h1 id="그래서-Spring-Boot-Actuator란"><a href="#그래서-Spring-Boot-Actuator란" class="headerlink" title="그래서 Spring Boot Actuator란"></a>그래서 Spring Boot Actuator란</h1><p>간단히 말하자면 Spring Boot Application의 상태를 관리해준다.</p><ul><li>Spring Boot Application의 상태 정보(health, properties, beans, 구동된 AutoConfiguration 목록 등)를 다룰 수 있도록 자동 설정.</li><li>각종 추상화 클래스(HealthIndicator 등)을 제공하여, 상태 정보를 변경할 수 있도록 Service를 제공.</li></ul><h1 id="써먹을-만한-설정과-사용자화-가능한-것들"><a href="#써먹을-만한-설정과-사용자화-가능한-것들" class="headerlink" title="써먹을 만한 설정과 사용자화 가능한 것들"></a>써먹을 만한 설정과 사용자화 가능한 것들</h1><h2 id="노출할-항목-설정"><a href="#노출할-항목-설정" class="headerlink" title="노출할 항목 설정"></a>노출할 항목 설정</h2><p>앞서 본 샘플에서는 많은 정보들이 노출되고 있었다. <code>auditevents</code>, <code>beans</code>, <code>health</code>, <code>env</code> 등등, 필요해 보이는 것부터 T.M.I.까지 있다. <code>application.properties</code>에서 <code>management.endpoints.web.exposure.include</code>에 필요한 endpoint의 id를 설정할 수 있다. endpoint의 목록은 <a href="https://docs.spring.io/spring-boot/docs/2.0.2.RELEASE/reference/htmlsingle/#production-ready-endpoints" target="_blank" rel="noopener">레퍼런스 문서</a>를 참고하자.</p><p><strong>예제: health와 metrics 정보만 노출</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">management.endpoints.web.exposure.include=health,metrics</span><br></pre></td></tr></table></figure><h2 id="Endpoint-경로-설정"><a href="#Endpoint-경로-설정" class="headerlink" title="Endpoint 경로 설정"></a>Endpoint 경로 설정</h2><p>앞에서 소개한 것과 같이 <code>management.endpoint.web.base-path(기본값 /actuator)</code>를 수정하여 base-path를 수정할 수 있다. 그 외에도 <code>management.endpoints.web.path-mapping.&lt;id&gt;</code>값을 수정하여, 특정 id의 endpoint의 경로를 수정할 수 있다.</p><p><strong>예제: health의 경로를 /monitor/healthcheck로 변경</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">management.endpoints.web.base-path=/monitor</span><br><span class="line">management.endpoints.web.path-mapping.health=healthcheck</span><br></pre></td></tr></table></figure><h2 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h2><p><code>spring-boot-actuator</code>는 기본적으로 <strong>클라우드 환경에서 관리자가 각종 애플리케이션의 상태를 파악하기 쉽도록 설계되어 있다.</strong> 때문에 필요한 경우 외부 UI를 구성한 다른 도메인명을 가진 Web Application에서 각각의 서비스 애플리케이션의 상태를 파악하기 위해서 actuator 정보를 요청할 수도 있다. 이럴때 CORS를 설정하여 사용할 수 있다.</p><p><strong>예제: <a href="http://other-domain.com" target="_blank" rel="noopener">http://other-domain.com</a> 의 GET, POST요청을 허용</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">management.endpoints.web.cors.allowed-origins=http://other-domain.com</span><br><span class="line">management.endpoints.web.cors.allowed-methods=GET,POST</span><br></pre></td></tr></table></figure><h2 id="Health-Endpoint"><a href="#Health-Endpoint" class="headerlink" title="Health Endpoint"></a>Health Endpoint</h2><h3 id="Details"><a href="#Details" class="headerlink" title="Details"></a>Details</h3><p>Health Endpoint는 위 샘플에서 소개된 것 외에도 사실상 많은 정보들을 내보일 수 있다. 이전의 샘플 소스로 돌아가서 <code>pom.xml</code>과 <code>application.properties</code>를 아래와 같이 수정해보자.</p><p><strong>pom.xml: jpa와 h2 database 의존성 추가</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;com.h2database&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;h2&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p><strong>application.properties: 상세 정보를 노출하도록 변경</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">management.endpoint.health.show-details=always</span><br></pre></td></tr></table></figure><p>다시 애플리케이션을 실행시킨 후 <code>GET /actuator/health</code> 요청을 보내보면 아래와 같이 응답이 온다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;  </span><br><span class="line">   &quot;status&quot;:&quot;UP&quot;,</span><br><span class="line">   &quot;details&quot;:&#123;  </span><br><span class="line">      &quot;db&quot;:&#123;  </span><br><span class="line">         &quot;status&quot;:&quot;UP&quot;,</span><br><span class="line">         &quot;details&quot;:&#123;  </span><br><span class="line">            &quot;database&quot;:&quot;H2&quot;,</span><br><span class="line">            &quot;hello&quot;:1</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>애플리케이션에서 의존하고 있는 시스템의 Health check도 함께 파악할 수 있다. <code>DataSource</code> 외에도 <code>Disk</code>, <code>Cassandra</code>, <code>ElasticSearch</code>, <code>Redis</code> 등의 health check를 확인할 수 있다.</p><h3 id="사용자-정의-Health-Indicator"><a href="#사용자-정의-Health-Indicator" class="headerlink" title="사용자 정의 Health Indicator"></a>사용자 정의 Health Indicator</h3><p>Health Endpoint의 내용은 <code>HealthIndicator</code>를 구현하여 정의할 수 있다.</p><p><strong>HealthIndicator</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HealthIndicator</span> </span>&#123;</span><br><span class="line">    <span class="function">Health <span class="title">health</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>아래는 간단하게 health indicator를 구현한 예제이다.</p><ul><li><code>PUT /actuator/health/up</code> : UP 상태로 변경</li><li><code>PUT /actuator/health/down</code> : DOWN 상태로 변경</li><li><code>PUT /actuator/health/maintenance</code> : 점검 상태로 변경</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"$&#123;management.endpoints.web.base-path:/actuator&#125;"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomHealthIndicator</span> <span class="keyword">implements</span> <span class="title">HealthIndicator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;Health&gt; health = <span class="keyword">new</span> AtomicReference&lt;&gt;(Health.up().build());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Health <span class="title">health</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> health.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping</span>(<span class="string">"$&#123;management.endpoints.web.path-mapping.health:health&#125;/up"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Health <span class="title">up</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Health up = Health.up().build();</span><br><span class="line">        <span class="keyword">this</span>.health.set(up);</span><br><span class="line">        <span class="keyword">return</span> up;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping</span>(<span class="string">"$&#123;management.endpoints.web.path-mapping.health:health&#125;/down"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Health <span class="title">down</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Health down = Health.down().build();</span><br><span class="line">        <span class="keyword">this</span>.health.set(down);</span><br><span class="line">        <span class="keyword">return</span> down;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping</span>(<span class="string">"$&#123;management.endpoints.web.path-mapping.health:health&#125;/maintenance"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Health <span class="title">maintenance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Health maintenance = Health.status(<span class="keyword">new</span> Status(<span class="string">"MAINTENANCE"</span>, <span class="string">"점검중"</span>)).build();</span><br><span class="line">        <span class="keyword">this</span>.health.set(maintenance);</span><br><span class="line">        <span class="keyword">return</span> maintenance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>각 URL에 맞춰서 <code>health</code>의 값을 변경한다. 기본적으로 <code>up</code>, <code>down</code>, <code>out-of-service</code>, <code>unkwon</code>의 상태값이 존재하지만 <code>maintenance</code>의 상태값은 없다. 사실 의미상 <code>out-of-service</code>와 동일하지만, 사용자화를 할 수 있다는 걸 보이기 위해서 새로 만들었다. 새로운 상태값을 만들어 actuator에서 인식하도록 만들려면 <code>application.properties</code>를 수정해야한다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 심각도에 따른 순서</span><br><span class="line">management.health.status.order=DOWN, MAINTENANCE, UNKOWN, UP</span><br><span class="line"></span><br><span class="line"># 각 상태별 Http 응답 코드</span><br><span class="line">management.health.status.http-mapping.DOWN=503</span><br><span class="line">management.health.status.http-mapping.MAINTENANCE=503</span><br><span class="line">management.health.status.http-mapping.UNKNOWN=200</span><br><span class="line">management.health.status.http-mapping.UP=200</span><br></pre></td></tr></table></figure><p>이제 애플리케이션을 실행하여 <code>PUT /actuator/health/maintenance</code>를 요청한 후 <code>GET /actuator/health</code>로 확인해보자 아래와 같이 나온다.</p><p><img src="maintenance.png" alt="점검중"></p><h4 id="HealthIndicator를-구현하며-management-endpoint-health-show-details-always가-설정된-경우"><a href="#HealthIndicator를-구현하며-management-endpoint-health-show-details-always가-설정된-경우" class="headerlink" title="HealthIndicator를 구현하며, management.endpoint.health.show-details=always가 설정된 경우"></a>HealthIndicator를 구현하며, <code>management.endpoint.health.show-details=always</code>가 설정된 경우</h4><p>사용자화한 항목을 하나의 상세로 표시해준다.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;  </span><br><span class="line">   <span class="attr">"status"</span>:<span class="string">"UP"</span>,</span><br><span class="line">   <span class="attr">"details"</span>:&#123;  </span><br><span class="line">      <span class="attr">"custom"</span>:&#123;  </span><br><span class="line">         <span class="attr">"status"</span>:<span class="string">"UP"</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h2><p>간단히 말하자면 시계열 지표로 활용할 수 있는 정보를 관리한다. 아래는 그 일부이다.</p><ul><li>JVM 정보<ul><li>thread 수</li><li>GC 정보</li><li>heap 정보</li></ul></li><li>DBCP 정보</li><li>PROCESS 관련 정보</li><li>CPU<ul><li>USAGE</li><li>LOAD</li></ul></li><li>FILE<ul><li>최대 사용가능한 File Descriptor 수</li><li>현재 사용중인 File Descriptor 수</li></ul></li></ul><h3 id="사용자-정의-Metircs"><a href="#사용자-정의-Metircs" class="headerlink" title="사용자 정의 Metircs"></a>사용자 정의 Metircs</h3><p>Metrics의 정보도 사용자 정의할 수 있다. 예를 들어 현재 처리중인 동시 요청 수나 분당 요청 처리량 등을 표시할 수 있다. 방법은 간단하다. <code>MeterRegistry</code>를 주입받아 사용하면 된다.  아래는 처리중인 동시 요청 수에 대한 예제이다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class ConcurrentTransactionCountInterceptor extends HandlerInterceptorAdapter &#123;</span><br><span class="line"></span><br><span class="line">    private final Counter counter;</span><br><span class="line"></span><br><span class="line">    public ConcurrentTransactionCountInterceptor(MeterRegistry meterRegistry) &#123;</span><br><span class="line">        this.counter = meterRegistry.counter(&quot;transaction.current.count&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;</span><br><span class="line">        counter.increment();</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception &#123;</span><br><span class="line">        counter.increment(-1d);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>GET /actuator/metrics/transaction.current.count</code>를 호출하면 아래와 같이 나온다.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"transaction.current.count"</span>,</span><br><span class="line">  <span class="attr">"measurements"</span>:[</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"statistic"</span>: <span class="string">"COUNT"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p>Spring Boot Actuator에 대해서 간략하게 살펴보았다. actuator에서는 이외에도 많은 기능을 제공해주지만, 자주 사용할 것 같은 기능 위주로 살펴봤다.</p><p>actuator는 기본적으로 애플리케이션의 상태를 조회하고, 변경할 수 있도록 기능을 추상화하여 정의하고 있다. 추상화된 기능들에 대한 간단한 구현체들을 제공해주며, 개발자로 하여금 사용자 정의를 통해 더욱 상세한 설정을 할 수 있도록 가능성을 열어두었다. actuator로 인해 프로젝트 내에서 애플리케이션 관리를 통합해서 사용할 수 있으며, 이는 클라우드 환경에서 애플리케이션을 관리하는 데 매우 유용하게 사용할 수 있다. Load Balancing은 물론이거니와 필요시 Instance를 자동으로 배포, 제거하는 데에 유용한 정보들을 제공해줄 수 있다.</p><p>애플리케이션 개발팀과 인프라스트럭처 관리팀이 나누어진 경우, 인프라스트럭처 관리팀에서 정해둔 정책이 있다면 <code>spring-boot-starter</code>를 사용자 정의하여 <code>actuator</code>를 회사, 혹은 팀 단위에 맞춰서 미리 정의해서 사용해보자. 그렇게 되면 개발팀은 서비스 로직에만 신경쓸 수 있게 될 것이다.</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;웹 개발자로서 웹 애플리케이션을 만들 때 신경써야할 것은 서비스 로직 뿐만이 아니다. 웹 애플리케이션의 사용자는 누구인지(일반인? 외부시스템?), 어떤 경로로 애플리케이션에 요청을 할 지(Load Balancing, Fire Wall), 요청 수나 TPS 등 많은 것들을 고려해야한다. 이번에 소개할 &lt;code&gt;spring-boot-actuator&lt;/code&gt;라는 모듈은 &lt;strong&gt;애플리케이션의 상태&lt;/strong&gt;를 종합적으로 정리하여 우리에게 제공해준다. 본문에서는 &lt;a href=&quot;https://github.com/spring-projects/spring-boot/tree/master/spring-boot-samples&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Spring Boot Samples&lt;/a&gt;에 있는 프로젝트 중에서 &lt;code&gt;spring-boot-sample-actuator-ui&lt;/code&gt;를 가져와 살짝 소스를 수정하여 actuator가 무엇이고 어떤 일 해주는지 알아보려한다.&lt;/p&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
      <category term="boot" scheme="https://supawer0728.github.io/categories/spring/boot/"/>
    
      <category term="actuator" scheme="https://supawer0728.github.io/categories/spring/boot/actuator/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="spring-boot" scheme="https://supawer0728.github.io/tags/spring-boot/"/>
    
      <category term="spring-boot-actuator" scheme="https://supawer0728.github.io/tags/spring-boot-actuator/"/>
    
  </entry>
  
  <entry>
    <title>(Spring Boot) 다중 DataSource 사용하기 with Sharding</title>
    <link href="https://supawer0728.github.io/2018/05/06/spring-boot-multiple-datasource/"/>
    <id>https://supawer0728.github.io/2018/05/06/spring-boot-multiple-datasource/</id>
    <published>2018-05-06T14:34:38.000Z</published>
    <updated>2018-09-03T09:30:38.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>Spring Boot를 사용해서 Database Sharding을 처리할 수 있을까?<br>요즘 NoSQL에서는 Sharding과 관련해서 많은 편의를 제공한다. 알아서 Sharding을 제공해주고, 클러스터에 노드가 추가되면 Shard key를 기반으로 자동으로 새로운 노드로 값들을 분배해주거나, 노드를 제거하면 대상 노드에 있던 값들을 Shard Key에 맞추어 남은 노드로 분배해준다. 자세히 알아보지는 않았지만 RDBMS 측의 각종 벤더들도 이러한 아키텍처를 구현기위한 방법을 제공할 것이라 생각된다.(예를 들어 MySQL의 Fabric - 현재 MySQL Utilities에 통합)</p><p>이번 포스트에서는 RDBMS Sharding을 각 벤더에 의존해서 구현하지 않고, Spring Boot로 편리하게 설정을 추상화하여 사용할 방법에 대해 공유하려 한다. 앞서 Sharding에 대해서 거창하게 이야기를 했지만, 본문에서 다루고자 하는 영역은 아래의 두 가지 기능이다.</p><ul><li>이름 기반으로 다중 DataSource 정보를 등록 : AbstractRoutingDataSource</li><li>특정 값을 기반으로 대상 DataSource를 사용 : Spring AOP</li></ul><a id="more"></a><h1 id="이름-기반으로-다중-DataSource-정보-등록하기"><a href="#이름-기반으로-다중-DataSource-정보-등록하기" class="headerlink" title="이름 기반으로 다중 DataSource 정보 등록하기"></a>이름 기반으로 다중 DataSource 정보 등록하기</h1><h2 id="AbstractRoutingDataSource"><a href="#AbstractRoutingDataSource" class="headerlink" title="AbstractRoutingDataSource"></a>AbstractRoutingDataSource</h2><p>우선 <code>spring-jdbc</code> 모듈에 있는 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jdbc/datasource/lookup/AbstractRoutingDataSource.html" target="_blank" rel="noopener">AbstractRoutingDataSource</a>에 대해서 먼저 소개를 해야할 것 같다. 여러 DataSource를 등록하고, 특정 상황에 맞게 원하는 DataSource를 사용할 수 있도록 추상화한 클래스다. 이 클래스의 <code>public void setTargetDataSources(Map&lt;Object, Object&gt; targetDataSource)</code>를 호출하여 <code>String:DataSource</code>을 <code>키:값</code>으로하는 <code>Map</code>을 저장할 수 있다. 또한 <code>Object determineCurrentLooupKey()</code>를 오버라이드해서 상황에 맞게 Key를 반환하도록 구현할 수 있다.</p><p>예시로 MyBatis의 <a href="https://github.com/hatunet/spring-data-mybatis/blob/master/src/main/java/org/springframework/data/mybatis/replication/datasource/ReplicationRoutingDataSource.java" target="_blank" rel="noopener">ReplicationRoutingDataSource</a>를 살펴보자.</p><p>아래 소스는 <code>ReplicationRoutingDataSource</code>의 내용을 간략화한 것이다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReplicationRoutingDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 1</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ReplicationRoutingDataSource</span><span class="params">(DataSource master, List&lt;DataSource&gt; slaves)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">super</span>.setDefaultTargetDataSource(master);</span><br><span class="line">    Map&lt;Object, Object&gt; targetDataSources =</span><br><span class="line">      IntStream.range(<span class="number">0</span>, slaves.size)</span><br><span class="line">               .boxed()</span><br><span class="line">               .collect(toMap(n -&gt; <span class="string">"slave_"</span> + n, n -&gt; slaves.get(n));</span><br><span class="line">    targetDataSources.put(<span class="string">"master"</span>, master);</span><br><span class="line">    <span class="keyword">super</span>.setTargetDataSources(targetDataSources);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> transactionActive = TransactionSynchronizationManager.isActualTransactionActive();</span><br><span class="line">    <span class="keyword">if</span> (transactionActive) &#123;</span><br><span class="line">      <span class="keyword">boolean</span> readOnly = TransactionSynchronizationManager.isCurrentTransactionReadOnly();</span><br><span class="line">      <span class="keyword">if</span> (readOnly) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"slave_"</span> + dataSourceSelectPolicy.select(slaves);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"master"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1: 생성자를 통해서 <code>master</code>로 사용할 <code>DataSource</code>와 <code>slave</code>로 사용할 <code>DataSource</code> 목록을 받고 있다.<br>2: 현재 트랜잭션이 활성화되어 있고, 읽기 전용이면 <code>slave</code> 중에 하나를 선택해서 반환하도록 되어 있다.</p><p>이를 응용해서 이름 기반으로 동작하는 <code>AbstractRoutingDataSource</code>를 구현할 수 있다.</p><h2 id="application-yml을-이용해서-구현해보기"><a href="#application-yml을-이용해서-구현해보기" class="headerlink" title="application.yml을 이용해서 구현해보기"></a>application.yml을 이용해서 구현해보기</h2><p>아래와 같은 구조로 RDBMS가 구성되어 있다고 가정해보자.</p><img src="http://www.plantuml.com/plantuml/svg/IqaiIKnAB4vLo4qiBaajqiZ9JqxCoSWlBh4oDZOmqrIevb9GY4xEBqgD1J6ACnABKWmHJADOhbekhXIO6SKvYMMfg4QO8ncX0PRNH389GyG8Bb8B0000"><p>이러한 구조를 아래와 같은 property를 등록하여 설정되도록 하려고 한다.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">named-routing-data-source:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  slave-suffix:</span> <span class="bullet">-slave</span></span><br><span class="line"><span class="attr">  default-data-source:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  data-sources:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">core</span></span><br><span class="line"><span class="attr">      hikari:</span></span><br><span class="line"><span class="attr">        username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">        password:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">        jdbc-url:</span> <span class="attr">jdbc:mysql://localhost:3306/core?useSSL=false</span></span><br><span class="line"><span class="attr">    - slave-of:</span> <span class="string">core</span> <span class="comment"># slave의 경우에는 `slave-of`로 등록한다</span></span><br><span class="line"><span class="attr">      hikari:</span></span><br><span class="line"><span class="attr">        username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">        password:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">        jdbc-url:</span> <span class="attr">jdbc:mysql://localhost:3307/core?useSSL=false</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">shard1</span></span><br><span class="line"><span class="attr">      hikari:</span></span><br><span class="line"><span class="attr">        username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">        password:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">        jdbc-url:</span> <span class="attr">jdbc:mysql://localhost:3306/shard1?useSSL=false</span></span><br><span class="line"><span class="attr">    - slave-of:</span> <span class="string">shard1</span></span><br><span class="line"><span class="attr">      hikari:</span></span><br><span class="line"><span class="attr">        username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">        password:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">        jdbc-url:</span> <span class="attr">jdbc:mysql://localhost:3307/shard1?useSSL=false</span> </span><br><span class="line"><span class="attr">    - - name:</span> <span class="string">shard2</span></span><br><span class="line"><span class="attr">      hikari:</span></span><br><span class="line"><span class="attr">        username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">        password:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">        jdbc-url:</span> <span class="attr">jdbc:mysql://localhost:3306/shard2?useSSL=false</span></span><br><span class="line"><span class="attr">    - slave-of:</span> <span class="string">shard2</span></span><br><span class="line"><span class="attr">      hikari:</span></span><br><span class="line"><span class="attr">        username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">        password:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">        jdbc-url:</span> <span class="attr">jdbc:mysql://localhost:3307/shard2?useSSL=false</span></span><br></pre></td></tr></table></figure><p>위 properties는 java로 아래와 같이 나타낼 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 전역 설정</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"named-routing-data-source"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamedRoutingDataSourceGlobalProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Boolean enabled;</span><br><span class="line">  <span class="keyword">private</span> String slaveSuffix = <span class="string">"-slave"</span>;</span><br><span class="line">  <span class="keyword">private</span> String defaultDataSource = <span class="string">"default"</span>;</span><br><span class="line">  <span class="keyword">private</span> List&lt;NamedRoutingDataSourceTargetProperties&gt; dataSources;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DataSource 항목 설정</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamedRoutingDataSourceTargetProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> String slaveOf;</span><br><span class="line">  <span class="keyword">private</span> HikariConfig hikari;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSlave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !StringUtils.isEmpty(slaveOf);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">check</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> hasName = !StringUtils.isEmpty(name);</span><br><span class="line">    <span class="keyword">if</span> (hasName == isSlave) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"name 혹은 slaveOf 둘 중 하나만 있어야 합니다"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>NamedRoutingDataSourceTargetProperties</code>에서 <code>name</code>이나 <code>slaveOf</code> 둘 중 하나만 값이 있어야 한다.<ul><li><code>slaveOf</code>가 <code>a</code>인 경우 <code>name</code>은 <code>&quot;a&quot; + slaveSuffix</code>가 된다.</li></ul></li></ul><h2 id="NamedRoutingDataSource와-NamedDataSource"><a href="#NamedRoutingDataSource와-NamedDataSource" class="headerlink" title="NamedRoutingDataSource와 NamedDataSource"></a>NamedRoutingDataSource와 NamedDataSource</h2><p><code>NamedRoutingDataSource</code>는 <code>AbstractRoutingDataSource</code>를 구현하였다.  <code>NamedDataSource</code>는 <code>NamedRoutingDataSource</code>에서 들고 있을 대상이다. 먼저 <code>NamedDataSource</code>부터 살펴보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span>(access = AccessLevel.PRIVATE)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamedDataSource</span> <span class="keyword">implements</span> <span class="title">DataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String slaveOf;</span><br><span class="line">  <span class="meta">@Delegate</span>(types = DataSource.class)</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> DataSource delegate;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NamedDataSource <span class="title">slaveOf</span><span class="params">(String slaveOf, String slaveSuffix, DataSource delegate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NamedDataSource(slaveOf + slaveSuffix, slaveOf, delegate);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NamedDataSource <span class="title">asMaster</span><span class="params">(String name, DataSource delegate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NamedDataSource(name, <span class="keyword">null</span>, delegate);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSlave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !StringUtils.isEmpty(slaveOf);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>NamedDataSource</code>는 slave(<code>slaveOf()</code>)로, 혹은 master(<code>asMaster()</code>)로 생성된다. 그리고 <code>DataSource</code>를 구현하고 있는데, 구현에 필요한 메서드는 모두 <code>delegate</code>에 위임하였다.</p><p>다음은 이 <code>NamedDataSource</code>를 가지고 routing 처리를 할 <code>NamedRoutingDataSource</code>를 살펴보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamedRoutingDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String defaultDataSource;</span><br><span class="line">  <span class="comment">// 이름을 key로 하여 실제 대상을 메모리로 들고 있는다</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, NamedDataSource&gt; dataSourceMap;</span><br><span class="line">  <span class="comment">// master key에 대한 slave key를 들고 있는다.</span></span><br><span class="line">  <span class="comment">// 여러 slave를 등록할 수 있도록 구현하고 싶다면 Map&lt;String, List&lt;String&gt;&gt;으로 구현할 수 있다.</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; masterSlaveMap;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">NamedRoutingDataSource</span><span class="params">(String defaultDataSource, List&lt;NamedDataSource&gt; dataSources)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.defaultDataSource = defaultDataSource;</span><br><span class="line">    <span class="keyword">this</span>.dataSourceMap = createDataSourceMap(dataSources);</span><br><span class="line">    <span class="keyword">this</span>.masterSlaveMap = dataSourceMap.values()</span><br><span class="line">                                       .stream()</span><br><span class="line">                                       .filter(NamedDataSource::isSlave)</span><br><span class="line">                                       .collect(toMap(NamedDataSource::getSlaveOf, NamedDataSource::getName));</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// AbstractRoutingDataSource에 등록</span></span><br><span class="line">    <span class="keyword">super</span>.setTargetDataSources(dataSourceMap.entrySet().stream().collect(toMap(Entry::getKey, Entry::getValue)));</span><br><span class="line">    <span class="keyword">super</span>.setDefaultTargetDataSource(dataSourceMap.get(defaultDataSource));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Map&lt;String, NamedDataSource&gt; <span class="title">createDataSourceMap</span><span class="params">(List&lt;NamedDataSource&gt; dataSources)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dataSources.stream().collect(toMap(NamedDataSource::getName, Function.identity()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// routing 로직</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String dataSourceName = NamedRoutingDataSourceManager.getCurrentDataSourceName();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dataSourceName == <span class="keyword">null</span>) &#123;</span><br><span class="line">      dataSourceName = defaultDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> transactionActive = TransactionSynchronizationManager.isActualTransactionActive();</span><br><span class="line">    <span class="keyword">if</span> (transactionActive) &#123;</span><br><span class="line">      <span class="keyword">boolean</span> readOnly = TransactionSynchronizationManager.isCurrentTransactionReadOnly();</span><br><span class="line">      <span class="keyword">if</span> (readOnly) &#123;</span><br><span class="line">        dataSourceName = masterSlaveMap.getOrDefault(dataSourceName, dataSourceName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.debug(<span class="string">"dataSourceName: &#123;&#125;"</span>, dataSourceName);</span><br><span class="line">    <span class="keyword">return</span> dataSourceName;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;NamedDataSource&gt; <span class="title">masters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dataSourceMap.values().stream().filter(dataSource -&gt; !dataSource.isSlave()).collect(Collectors.toList());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>NamedRoutingDataSourceManager</code>에서 현재 사용할 DataSource의 이름을 가지고 올 수 있다(<code>getDataSourceName()</code>). <code>NamedRoutingDataSourceManager</code>의 구현은 아래와 같다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamedRoutingDataSourceManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; currentDataSourceName = <span class="keyword">new</span> NamedThreadLocal&lt;&gt;(<span class="string">"name of DataSource selected in this thread"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">NamedRoutingDataSourceManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"this class can't be instance"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getCurrentDataSourceName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> currentDataSourceName.get();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setCurrentDataSourceName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    currentDataSourceName.set(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeCurrentDataSourceName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    currentDataSourceName.remove();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ThreadLocal</code>로 현재 사용할 DataSource의 이름을 설정할 수 있다. 어디선가는 이 이름을 설정해줘야 <code>Sharding</code>이 제대로 동작할 것이다. 만약 이름이 없다면 <code>NamedRoutingDataSource</code>는 항상 <code>defaultDataSource</code>만 반환할 것이다.</p><h2 id="Spring-AOP를-활용해서-DataSource-이름-설정하기"><a href="#Spring-AOP를-활용해서-DataSource-이름-설정하기" class="headerlink" title="Spring AOP를 활용해서 DataSource 이름 설정하기"></a>Spring AOP를 활용해서 DataSource 이름 설정하기</h2><p>긴 설명보다는 아래 소스를 보고 어떻게 동작할 지 설명하는게 빠를 것 같다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardRepository</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 1</span></span><br><span class="line">  <span class="meta">@SetDataSourceName</span>(getterType = HashModularDataSourceNameGetter.class)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;Board&gt; <span class="title">findByWriterId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 2</span></span><br><span class="line">  <span class="meta">@SetDataSourceName</span>(spel = <span class="string">"#this[0].id"</span>, getterType = HashModularDataSourceNameGetter.class)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;Board&gt; <span class="title">findByWriter</span><span class="params">(Writer writer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SetDataSourceName &#123;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">spel</span><span class="params">()</span> <span class="keyword">default</span> "#<span class="keyword">this</span>[0]"</span>;</span><br><span class="line">  Class&lt;? extends DataSourceNameGetter&gt; getterType();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataSourceNameGetter</span> </span>&#123;</span><br><span class="line">  <span class="function">String <span class="title">getDataSourceName</span><span class="params">(Object object)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashModularDataSourceNameGetter</span> <span class="keyword">implements</span> <span class="title">DataSourceNameGetter</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> modValue;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">HashModularDataSourceNameGetter</span><span class="params">(NamedRoutingDataSource dataSource)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.modValue = dataSource.masters().size();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getDataSourceName</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"shard"</span> + (object.hashCode % modValue + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1: <code>findByWriterId</code>의 <code>id</code>값의 <code>hashCode()</code> 결과에 modular 연산을 수행하여 대상 DataSource의 이름을 설정할 수 있다.<br>2: <a href="https://docs.spring.io/spring/docs/5.0.5.RELEASE/spring-framework-reference/core.html#expressions" target="_blank" rel="noopener">SpEL</a>를 적용하여 메서드의 특정 argument를 대상으로 DataSource의 이름을 설정할 수 있다.</p><p>이를 가능하게 하는 <code>SetDataSourceNameAspect</code> 클래스는 다음과 같이 정의할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SetDataSourceNameAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> BeanFactory factory;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Pointcut</span>(<span class="string">"@annotation(setDataSourceName)"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hasAnnotation</span><span class="params">(SetDataSourceName setDataSourceName)</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Around</span>(<span class="string">"hasAnnotation(setDataSourceName)"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint joinPoint, SetDataSourceName setDataSourceName)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">    Object getterKey = parser.parseExpression(setDataSourceName.spel()).getValue(joinPoint.getArgs());</span><br><span class="line">    <span class="comment">// Spring Context에 등록되어 있는 Bean 중에서 Type을 기반으로 검색</span></span><br><span class="line">    DataSourceNameGetter getter = factory.getBean(setDataSourceName.getterType());</span><br><span class="line">    String dataSourceName = getter.getDataSourceName(getterKey);</span><br><span class="line">    <span class="comment">// NamedRoutingDataSourceManager에 사용할 DataSource의 이름 등록</span></span><br><span class="line">    NamedRoutingDataSourceManager.setCurrentDataSourceName(dataSourceName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> joinPoint.proceed();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// ThreadLocal을 사용하므로 반드시 `remove()`를 실행할 것</span></span><br><span class="line">      NamedRoutingDataSourceManager.removeCurrentDataSourceName();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h1><p>여러 DataSource를 이름 기반으로 등록하고, Spring AOP를 통해서 사용할 DataSource의 이름을 정하도록 소스를 작성해보았다. <code>AbstractRoutingDataSource</code>와 Spring AOP의 원리를 이용해 간단하게 추상화해보고 구현까지 해보았다. 해당 소스에서는 복잡성을 증가시키지 않기 위해 <code>slave</code>는 하나라고 단정하고 진행하였는데, 필요하다면 <code>slave</code> 용도의 DataSource를 따로 <code>SlaveNamedRoutingDataSource</code>같은 클래스로 묶어서 단순한 round-robin 정도라면 간단히 load balancing까지 쉽게 할 수 있을 것이다.<br>한 가지 애매한 것이 DataSource의 이름은 무슨 기준으로 정하느냐 하는 것이다. String으로 되어 있어, 등록하는 부분(<code>NamedDataSource</code>)과 실제로 값을 가져오는 부분(<code>DataSourceNameGetter</code>)에서 문자열을 잘못 입력하여 런타임 오류가 발생하는 가능성도 있는데, 이 부분에 있어서 좋은 해결책이 딱히 떠오르지는 않았다. 만약 강한 제약을 넣고 싶다면 <code>NamedDataSource</code>가 아니라 <code>EnumedDataSource</code>를 사용하는 것도 하나의 옵션으로 고려할 수 있지 않을까 생각된다.</p><p>위에서 소개한 내용 중에 <code>application.yml</code>에 설정된 property를 기반으로 <code>NamedRoutingDataSource</code>를 생성하는 소스는 빠져있다. property와 java 소스가 대칭을 이루기에 굳이 구현 소스를 넣지는 않았다. 상세한 구현이 궁금하다면 github 소스를 참고하자.</p><p>Github 소스 : <a href="https://github.com/supawer0728/parfait-spring-boot-starter-sharding" target="_blank" rel="noopener">https://github.com/supawer0728/parfait-spring-boot-starter-sharding</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;Spring Boot를 사용해서 Database Sharding을 처리할 수 있을까?&lt;br&gt;요즘 NoSQL에서는 Sharding과 관련해서 많은 편의를 제공한다. 알아서 Sharding을 제공해주고, 클러스터에 노드가 추가되면 Shard key를 기반으로 자동으로 새로운 노드로 값들을 분배해주거나, 노드를 제거하면 대상 노드에 있던 값들을 Shard Key에 맞추어 남은 노드로 분배해준다. 자세히 알아보지는 않았지만 RDBMS 측의 각종 벤더들도 이러한 아키텍처를 구현기위한 방법을 제공할 것이라 생각된다.(예를 들어 MySQL의 Fabric - 현재 MySQL Utilities에 통합)&lt;/p&gt;
&lt;p&gt;이번 포스트에서는 RDBMS Sharding을 각 벤더에 의존해서 구현하지 않고, Spring Boot로 편리하게 설정을 추상화하여 사용할 방법에 대해 공유하려 한다. 앞서 Sharding에 대해서 거창하게 이야기를 했지만, 본문에서 다루고자 하는 영역은 아래의 두 가지 기능이다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;이름 기반으로 다중 DataSource 정보를 등록 : AbstractRoutingDataSource&lt;/li&gt;
&lt;li&gt;특정 값을 기반으로 대상 DataSource를 사용 : Spring AOP&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="practice" scheme="https://supawer0728.github.io/categories/practice/"/>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
      <category term="practice" scheme="https://supawer0728.github.io/categories/spring/practice/"/>
    
      <category term="spring-boot" scheme="https://supawer0728.github.io/categories/spring/spring-boot/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="spring-boot" scheme="https://supawer0728.github.io/tags/spring-boot/"/>
    
      <category term="sharding" scheme="https://supawer0728.github.io/tags/sharding/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cache 장애 대응 방안</title>
    <link href="https://supawer0728.github.io/2018/04/18/spring-cache-fallback/"/>
    <id>https://supawer0728.github.io/2018/04/18/spring-cache-fallback/</id>
    <published>2018-04-17T16:20:53.000Z</published>
    <updated>2018-09-03T09:30:38.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>Spring은 <a href="https://docs.spring.io/spring/docs/5.0.5.RELEASE/spring-framework-reference/integration.html#cache" target="_blank" rel="noopener">캐시 추상화</a>를 통해서 쉽게 캐시를 사용할 수 있게 해준다. <code>CacheManager</code>를 잘 구현한다면 <code>@Cacheable</code>, <code>@CachePut</code>, <code>@CacheEvict</code> 등을 통해서 얼마든지 커스터마이징된 캐시를 사용할 수 있다. 하지만 의외로 장애에 대응하는 방안에 대해서는 Reference 상에서도 구체적인 설명을 해주지 않고 있다. 덕분에 다시 글 쓸 거리가 생긴 것 같다.</p><p>사용하는 캐시 시스템에 문제가 생겼을 때 어떻게 대처해야하는지는 어떤 정보를 캐시하느냐에 따라 다르다. 경우의 수 자체가 너무 많다. 또한 캐시 자체가 여러 용도로 쓰일 수 있다. HTTP 응답을 캐시하든지, Repository의 결과를 캐시하든지 혹은 Service의 결과를 캐시할 수도 있다. 본문에서는 아래 두 경우로 간단하게 나누고 이에 대한 해결법을 궁리해보고자 한다.</p><ul><li>부하가 많이 걸린다면? 2차 캐시 구성을 고려하자.(Local Cache, Global Cache 구성)</li><li>Global Cache에서 장애가 발생할 경우를 대비, Hystrix를 고려하자</li></ul><a id="more"></a><h1 id="서비스-입장에서-본-구조"><a href="#서비스-입장에서-본-구조" class="headerlink" title="서비스 입장에서 본 구조"></a>서비스 입장에서 본 구조</h1><p>MVC의 Controller에서 로직을 실행하기 위해 Service를 호출할 때 캐시를 사용하려 한다.</p><img src="http://www.plantuml.com/plantuml/svg/YovEBIhBJ4xLIqyjqT2CLT3LjLE8TavCpaYDLR1II0OnNY_Te_1wnPut2neKtixOyMRR72wO0jsYpFIC4f2EeDIKpE9We56fHR5SA3m5tPpKj1A4gGZD47q5-SMP9Vb5bN3htaoVeF1cmTJNcxUysj2Wy6PwsvivUrwlt0Ar6m00"><h1 id="기본-예제"><a href="#기본-예제" class="headerlink" title="기본 예제"></a>기본 예제</h1><p>우선 Spring에서 캐시를 사용하는 기본 예제를 간단히 작성하자. 여기서는 Redis를 캐시로 사용한다.</p><h2 id="의존성-설정"><a href="#의존성-설정" class="headerlink" title="의존성 설정"></a>의존성 설정</h2><p><code>Spring Boot</code>는 <code>2.0.1.RELEASE</code>를 사용했다.</p><p>2.0.x부터 redis를 사용시 <code>lettuce</code> 라이브러리가 기본으로 설정된다. 하지만 예전부터 Spring을 사용하는 경우라면 jedis에 익숙한 개발자가 많을 것으로 예상된다. 어차피 본문에서는 라이브러리에 따라 크게 달라지는 설정이 없으므로 익숙한 jedis를 사용하려고 한다. </p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-cache'</span>)</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-data-redis'</span>) &#123;</span><br><span class="line">        <span class="keyword">exclude</span> <span class="keyword">group</span>: <span class="string">'io.lettuce'</span>, module: <span class="string">'lettuce-core'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'redis.clients:jedis'</span>)</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-web'</span>)</span><br><span class="line">    compileOnly(<span class="string">'org.projectlombok:lombok'</span>)</span><br><span class="line">    testCompile(<span class="string">'org.springframework.boot:spring-boot-starter-test'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="도메인"><a href="#도메인" class="headerlink" title="도메인"></a>도메인</h2><p><strong>Person</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 테스트 정보를 넣기 위한 생성자</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(@NonNull String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 캐시에 저장된 json string을 인스턴스로 만들기 위한 생성자</span></span><br><span class="line">    <span class="meta">@JsonCreator</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(@JsonProperty(<span class="string">"id"</span>)</span> Long id,</span></span><br><span class="line"><span class="function">                  @<span class="title">JsonProperty</span><span class="params">(<span class="string">"name"</span>)</span> String name,</span></span><br><span class="line"><span class="function">                  @<span class="title">JsonProperty</span><span class="params">(<span class="string">"age"</span>)</span> <span class="keyword">int</span> age) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>PersonRepository</strong></p><p>본문에서는 Repository의 내용이 중요하진 않으므로 Method Signature만 적고 넘어가려고 한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">save</span><span class="params">(Person person)</span> </span>&#123; ... &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">findOne</span><span class="params">(Long id)</span> </span>&#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="응용-계층"><a href="#응용-계층" class="headerlink" title="응용 계층"></a>응용 계층</h2><p><strong>PersonService</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PersonRepository personRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PersonService</span><span class="params">(@NonNull PersonRepository personRepository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.personRepository = personRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 메서드 항상 실행, 결과값에 id가 null이 아닌 경우 캐싱</span></span><br><span class="line">    <span class="meta">@CachePut</span>(cacheNames = <span class="string">"person"</span>, key = <span class="string">"#person.id"</span>, unless = <span class="string">"#result.id != null"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">save</span><span class="params">(Person person)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"save() called"</span>);</span><br><span class="line">        <span class="keyword">return</span> personRepository.save(person);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 캐시에 값이 없는 경우에는 로그를 남기고 repository 실행</span></span><br><span class="line">    <span class="meta">@Cacheable</span>(cacheNames = <span class="string">"person"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">get</span><span class="params">(@NonNull Long id)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"get(Long) called"</span>);</span><br><span class="line">        <span class="keyword">return</span> personRepository.findOne(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/people"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PersonService personService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PersonController</span><span class="params">(@NonNull PersonService personService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.personService = personService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">get</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> personService.get(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">save</span><span class="params">(@RequestBody Person person)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> personService.save(person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="캐시-설정"><a href="#캐시-설정" class="headerlink" title="캐시 설정"></a>캐시 설정</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span>(proxyTargetClass = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheConfig</span> <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;redis.host:localhost&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String redisHost;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;redis.port:6379&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer redisPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisConnectionFactory <span class="title">jedisConnectionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 현 버전에서 factory.setHostName() 등의 api는 Deprecated되었다.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JedisConnectionFactory(<span class="keyword">new</span> RedisStandaloneConfiguration(redisHost, redisPort));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RedisCacheManager.RedisCacheManagerBuilder builder = RedisCacheManager.RedisCacheManagerBuilder.fromConnectionFactory(jedisConnectionFactory());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 값은 json 문자열로 넣는다. @class 필드로 클래스 정보가 들어간다.</span></span><br><span class="line">        RedisCacheConfiguration defaultConfig =</span><br><span class="line">                RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">                                       .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="keyword">new</span> GenericJackson2JsonRedisSerializer()))</span><br><span class="line">                                       .entryTtl(Duration.ofSeconds(<span class="number">20L</span>));</span><br><span class="line"></span><br><span class="line">        builder.cacheDefaults(defaultConfig);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="기본-데이터-인입"><a href="#기본-데이터-인입" class="headerlink" title="기본 데이터 인입"></a>기본 데이터 인입</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleCacheApplication</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PersonRepository personRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        personRepository.save(<span class="keyword">new</span> Person(<span class="string">"John"</span>, <span class="number">12</span>));</span><br><span class="line">        personRepository.save(<span class="keyword">new</span> Person(<span class="string">"Michel"</span>, <span class="number">16</span>));</span><br><span class="line">        personRepository.save(<span class="keyword">new</span> Person(<span class="string">"Chris"</span>, <span class="number">52</span>));</span><br><span class="line">        personRepository.save(<span class="keyword">new</span> Person(<span class="string">"Michael"</span>, <span class="number">25</span>));</span><br><span class="line">        personRepository.save(<span class="keyword">new</span> Person(<span class="string">"Susan"</span>, <span class="number">34</span>));</span><br><span class="line">        personRepository.save(<span class="keyword">new</span> Person(<span class="string">"Kim"</span>, <span class="number">44</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="테스트"><a href="#테스트" class="headerlink" title="테스트"></a>테스트</h2><p><strong>/people/1</strong>를 호출하면 <code>get(Long) called</code>가 로그에 한 번 남고, 이후에는 20초 동안 남지 않는다. 그리고 <code>redis-cli</code>로 키를 직접 조회해보면 아래와 같이 정보가 잘 인입되었음을 확인할 수 있다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get person::1</span><br><span class="line">&quot;&#123;\&quot;@class\&quot;:\&quot;com.parfait.study.simplecache.person.domain.Person\&quot;,\&quot;id\&quot;:1,\&quot;name\&quot;:\&quot;John\&quot;,\&quot;age\&quot;:12&#125;&quot;</span><br></pre></td></tr></table></figure><blockquote><p>소스코드 : <a href="https://github.com/supawer0728/simple-cache/tree/simple-cache" target="_blank" rel="noopener">https://github.com/supawer0728/simple-cache/tree/simple-cache</a></p></blockquote><h1 id="2차-캐시-구성"><a href="#2차-캐시-구성" class="headerlink" title="2차 캐시 구성"></a>2차 캐시 구성</h1><p>캐시에 많은 부하가 몰릴 수 있는 시스템의 경우 캐시를 수직적으로 나누어 1차, 2차 캐시를 사용하는 것이 좋을 때가 있다. 서비스 입장에서 구성을 나타내면 아래와 같다.</p><img src="http://www.plantuml.com/plantuml/svg/YovEBIhBJ4xLIqyjqT2CLT3LjLE8zibFJinnJapEI8rLi5B8I4qiU3EtHU5DqvetirQ-dJhZTTSKXHoG4eLaa1g5jpDslDasXmj56yYOr0mmHyC3Q81cB1SQNm7D9ZJz85dtdFma98SWsVbc-WI5LniclPcxHU7Dz3QGwrvFxL4eIitDBqb5SnMA8Rf5cUaP9I2pWr9JCek3WPvFBG9QZSnJqCr9JIj1jn_T88WP1Vd5cINvHPKWvo7RZijzCFLGrm40"><p>이러한 구성을 할 때 주의할 점이 있다. local cache와 global cache의 정보가 맞지 않는 기간이 발생할 수 있다는 것이다. 당연한 이야기지만 local cache의 만료 시간이 길면 길수록 그 기간은 길어진다. 때문에 일관된 데이터가 필요한 만큼 local cache의 만료 시간을 짧게 가져가야한다.</p><p>아쉽게도 이러한 n차 캐시 구성은 Spring에서 지원해주지 않는다. <code>CompositeCacheManager</code>라는 클래스가 있는데, 이 클래스는 등록된 여러 CacheManager 중에서 캐시명으로 Cache를 조회해서 하나만 내어준다.</p><p><strong>CompositeCacheManager</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Cache <span class="title">getCache</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (CacheManager cacheManager : <span class="keyword">this</span>.cacheManagers) &#123;</span><br><span class="line">    Cache cache = cacheManager.getCache(name);</span><br><span class="line">    <span class="keyword">if</span> (cache != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> cache;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>우리가 필요한 것은 CacheManager의 목록을 연결(Chained) 구성하는 것이다. 다행히 핵심 로직은 이미 라이브러리들이 구현해두었다. 우리는 CacheManager와 Cache만 연결 구현하면 된다. </p><h2 id="예제"><a href="#예제" class="headerlink" title="예제"></a>예제</h2><h3 id="ChainedCacheManager"><a href="#ChainedCacheManager" class="headerlink" title="ChainedCacheManager"></a>ChainedCacheManager</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainedCacheManager</span> <span class="keyword">implements</span> <span class="title">CacheManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;CacheManager&gt; cacheManagers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Cache&gt; cacheMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 반드시 하나 이상의 CacheManager를 등록</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChainedCacheManager</span><span class="params">(@NonNull CacheManager... cacheManagers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (cacheManagers.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.cacheManagers = Collections.unmodifiableList(Arrays.asList(cacheManagers));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 특정 캐시명으로 조회시 map에 없으면 ChainedCache를 생성</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cache <span class="title">getCache</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cacheMap.computeIfAbsent(name, key -&gt; <span class="keyword">new</span> ChainedCache(getCaches(key)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;Cache&gt; <span class="title">getCaches</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cacheManagers.stream().map(manager -&gt; manager.getCache(name)).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">getCacheNames</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cacheManagers.stream()</span><br><span class="line">                            .flatMap(manager -&gt; manager.getCacheNames().stream())</span><br><span class="line">                            .collect(Collectors.toSet());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>실제 로직을 담고 있는 <code>cacheManagers</code>를 두고 위임자 패턴으로 구현하였다. <code>getCache(String)</code> 호출이 있으면, <code>cacheManagers</code>의 순서로 해당 <code>CacheManager</code>의 <code>Cache</code>를 불러와 <code>ChainedCache</code>를 새로 생성한다.</p><h3 id="ChainedCache"><a href="#ChainedCache" class="headerlink" title="ChainedCache"></a>ChainedCache</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainedCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 실제 로직을 위임할 캐시들(local, global)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Cache&gt; caches;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> first = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChainedCache</span><span class="params">(List&lt;Cache&gt; caches)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.caches = Collections.unmodifiableList(caches);</span><br><span class="line">        <span class="keyword">this</span>.size = caches.size();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ValueWrapper <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 순서대로 캐시에서 값을 불러온다</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = first; i &lt; size; i++) &#123;</span><br><span class="line">            ValueWrapper valueWrapper = caches.get(i).get(key);</span><br><span class="line">            <span class="keyword">if</span> (valueWrapper != <span class="keyword">null</span> &amp;&amp; valueWrapper.get() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 첫번째 캐시에 값이 있으면 그대로 반환</span></span><br><span class="line">                <span class="keyword">if</span> (i == first) &#123;</span><br><span class="line">                    <span class="keyword">return</span> valueWrapper;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 첫번째 이후의 캐시에 값이 있으면 이전 index의 캐시에 각각 저장</span></span><br><span class="line">                putIntoPreviousIndexedCaches(i, key, valueWrapper.get());</span><br><span class="line">                <span class="keyword">return</span> valueWrapper;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putIntoPreviousIndexedCaches</span><span class="params">(<span class="keyword">int</span> index, Object key, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = index - <span class="number">1</span>; i &gt;= first; i--) &#123;</span><br><span class="line">            singleCachePut(caches.get(i), key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>CacheManager</code>에서 실제 구현을 담고 있는 <code>Cache</code>를 저장한다. 우리가 구현할 내용은 순서를 지정해주고 순서에 따라 값을 넣는 것이다. 실제 동작은 <code>caches</code>에 위임하자.</p><h3 id="CacheConfig"><a href="#CacheConfig" class="headerlink" title="CacheConfig"></a>CacheConfig</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span>(proxyTargetClass = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheConfig</span> <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;redis.host:localhost&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String redisHost;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;redis.port:6379&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer redisPort;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.cache.jcache.provider&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String jCacheProvider;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.cache.jcache.config&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> Resource jCacheConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisConnectionFactory <span class="title">jedisConnectionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JedisConnectionFactory(<span class="keyword">new</span> RedisStandaloneConfiguration(redisHost, redisPort));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">redisCacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RedisCacheManager.RedisCacheManagerBuilder builder = RedisCacheManager.RedisCacheManagerBuilder.fromConnectionFactory(jedisConnectionFactory());</span><br><span class="line"></span><br><span class="line">        RedisCacheConfiguration defaultConfig =</span><br><span class="line">                RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">                                       .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="keyword">new</span> GenericJackson2JsonRedisSerializer()))</span><br><span class="line">                                       .entryTtl(Duration.ofSeconds(<span class="number">20L</span>));</span><br><span class="line"></span><br><span class="line">        builder.cacheDefaults(defaultConfig);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LoggingCacheManager(builder.build(), <span class="string">"Global-Cache"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">jCacheCacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CachingProvider provider = Caching.getCachingProvider(jCacheProvider);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> LoggingCacheManager(<span class="keyword">new</span> JCacheCacheManager(provider.getCacheManager(jCacheConfig.getURI(), provider.getDefaultClassLoader())), <span class="string">"Local-Cache"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"can't create URI with spring.cache.jcache.config"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChainedCacheManager(jCacheCacheManager(), redisCacheManager());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RedisCacheManager</code>와 <code>JCacheCacheManager(ehCache)</code>를 각각 원격, 로컬 캐시로 잡았다. <code>LoggingCacheManager</code>는 필자가 로그를 남기기 위해 작성한 것이다.</p><h2 id="테스트-1"><a href="#테스트-1" class="headerlink" title="테스트"></a>테스트</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># 최초 호출시 service의 get(Long)까지 부른다</span><br><span class="line">03:24:17  INFO LoggingCache     : Local-Cache.getName() called</span><br><span class="line">03:24:17  INFO LoggingCache     : Local-Cache.get(Object) called</span><br><span class="line">03:24:17  INFO LoggingCache     : Global-Cache.get(Object) called</span><br><span class="line">03:24:17  INFO PersonService    : get(Long) called</span><br><span class="line">03:24:17  INFO LoggingCache     : Local-Cache.put(Object, Object) called</span><br><span class="line">03:24:17  INFO LoggingCache     : Global-Cache.put(Object, Object) called</span><br><span class="line"></span><br><span class="line"># 이후 10초 동안 local-cache의 값 호출</span><br><span class="line">03:24:19  INFO LoggingCache     : Local-Cache.getName() called</span><br><span class="line">03:24:19  INFO LoggingCache     : Local-Cache.get(Object) called</span><br><span class="line">03:24:23  INFO LoggingCache     : Local-Cache.getName() called</span><br><span class="line">03:24:23  INFO LoggingCache     : Local-Cache.get(Object) called</span><br><span class="line">03:24:26  INFO LoggingCache     : Local-Cache.getName() called</span><br><span class="line">03:24:26  INFO LoggingCache     : Local-Cache.get(Object) called</span><br><span class="line"></span><br><span class="line"># 10초가 지나면 local-cache가 만료됨. global-cache까지 호출</span><br><span class="line">03:24:29  INFO LoggingCache     : Local-Cache.getName() called</span><br><span class="line">03:24:29  INFO LoggingCache     : Local-Cache.get(Object) called</span><br><span class="line">03:24:29  INFO LoggingCache     : Global-Cache.get(Object) called</span><br><span class="line">03:24:29  INFO LoggingCache     : Local-Cache.put(Object, Object) called</span><br><span class="line"></span><br><span class="line"># 이후 10초간 local-cache만 호출</span><br><span class="line">03:24:34  INFO LoggingCache     : Local-Cache.getName() called</span><br><span class="line">03:24:34  INFO LoggingCache     : Local-Cache.get(Object) called</span><br><span class="line">03:24:38  INFO LoggingCache     : Local-Cache.getName() called</span><br><span class="line">03:24:38  INFO LoggingCache     : Local-Cache.get(Object) called</span><br><span class="line"></span><br><span class="line"># 10초 뒤 모든 캐시 만료되고 다시 service 호출</span><br><span class="line">03:24:43  INFO LoggingCache     : Local-Cache.getName() called</span><br><span class="line">03:24:43  INFO LoggingCache     : Local-Cache.get(Object) called</span><br><span class="line">03:24:43  INFO LoggingCache     : Global-Cache.get(Object) called</span><br><span class="line">03:24:43  INFO PersonService    : get(Long) called</span><br><span class="line">03:24:43  INFO LoggingCache     : Local-Cache.put(Object, Object) called</span><br><span class="line">03:24:43  INFO LoggingCache     : Global-Cache.put(Object, Object) called</span><br></pre></td></tr></table></figure><p>원하는 대로 정상적으로 동작하고 있다.</p><blockquote><p>소스코드 : <a href="https://github.com/supawer0728/simple-cache/tree/double-cache" target="_blank" rel="noopener">https://github.com/supawer0728/simple-cache/tree/double-cache</a></p></blockquote><h1 id="Hystrix-구성"><a href="#Hystrix-구성" class="headerlink" title="Hystrix 구성"></a>Hystrix 구성</h1><p>전역 캐시가 부하를 받아 Timeout이 발생하거나 특정 이유로 접근이 되지 않는 등의 장애가 발생한 경우, 일전에 공유했던 Hystrix를 고려해볼 수 있다. <strong>전역 캐시에 장애를 감지한 시점부터는 요청을 보내면 안된다.</strong> 물론 이 방법 또한 만병 통치약인 것은 아니다. 아래의 경우를 생각해보자.</p><ul><li>단순 네트워크 단절 : 다행이다. 1차 캐시와 repository로 2차 캐시를 복구할 때까지 운용할 수 있다.</li><li>트래픽 부하로 인한 장애 : 전역 캐시에 장애를 일으켰던 트래픽을 고스란히 1차 캐시와 repository로 견뎌내어야 한다. 2차 캐시를 복구하기 위한 잠깐의 시간 벌기는 가능할 것이다.</li></ul><p>위와 같은 한계가 있음을 숙지하고, 이제 Hystirx를 어떻게 구성할 수 있을지 예제로 작성하려한다.</p><img src="http://www.plantuml.com/plantuml/svg/YovEBIhBJ4xLIqyjqT2CLT3LjLE8zibFJinnJapEI8rLi5B8I4qiU3EtHU5DqvetirQ-dJhZTTSKXHoG4eLaa1g5jpDslDasXmj56yYOr0mmHyC3Q81cB1SQNm7D9ZJz85dtdFma98SWsVbc-WI5LniclPcxHU7Dz3QGwrvFxL4eIitDBqb5SnMA8Ref-ULvM8mEIat9B0u61aLgaSARUKlVJ5tmUk4SXJTpTxoTEaSXERCekJIpH26_83LF4Tr0a651gGNvnPab-KML8BEGNO7BdJ3rK5S20000"><h2 id="HystirxCacheManager"><a href="#HystirxCacheManager" class="headerlink" title="HystirxCacheManager"></a>HystirxCacheManager</h2><p>사실상 Spring에서 캐시 추상화(<code>CacheManager</code>, <code>Cache</code>)를 제공하니 우리는 앞에서 한 작업의 반복을 할 뿐이다. 실제 구현체를 <code>delegate</code>로 잡아두고 위임자 패턴을 사용하여 구현하자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixCacheManager</span> <span class="keyword">implements</span> <span class="title">CacheManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CacheManager delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Cache&gt; cacheMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HystrixCacheManager</span><span class="params">(@NonNull CacheManager delegate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cache <span class="title">getCache</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cacheMap.computeIfAbsent(name, key -&gt; <span class="keyword">new</span> HystrixCache(delegate.getCache(key)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">getCacheNames</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> delegate.getCacheNames();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="HystrixCache"><a href="#HystrixCache" class="headerlink" title="HystrixCache"></a>HystrixCache</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache delegate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HystrixCache</span><span class="params">(Cache delegate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ValueWrapper <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HystrixCacheGetCommand(delegate, key).execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> HystrixCachePutCommand(delegate, key, value).execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evict</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> HystrixCacheEvictCommand(delegate, key).execute();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>아쉽게도 <code>spring-netflix-starter-hystrix</code>에서 지원해주는 애노테이션들을 이용한 설정은 어렵다. 애노테이션을 사용해서 Hystirx설정을 하기 위해서는 설정할 인스턴스가 <code>ApplicationContext</code>에 Bean으로 등록되어야 한다. 때문에 여기서는 Spring의 도움 없이 직접 Hystrix API를 사용하였다. <code>execute()</code>는 HystrixCommand를 동기로 실행한다.</p><h2 id="HystrixCacheGetCommand"><a href="#HystrixCacheGetCommand" class="headerlink" title="HystrixCacheGetCommand"></a>HystrixCacheGetCommand</h2><p>앞에서 get, push, evict에 대해서 모두 <code>HystirxCacheXXXCommand</code>로 작성하였으나 본문에서는 <code>HystrixCacheGetCommand</code>만 살펴보려고 한다. 나머지든 대동소이하다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixCacheGetCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">ValueWrapper</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object key;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HystrixCacheGetCommand</span><span class="params">(Cache delegate, Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"testGroupKey"</span>))</span><br><span class="line">                    .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"cache-get"</span>))</span><br><span class="line">                    .andCommandPropertiesDefaults(</span><br><span class="line">                            HystrixCommandProperties.defaultSetter()</span><br><span class="line">                                                    .withExecutionTimeoutInMilliseconds(<span class="number">500</span>)</span><br><span class="line">                                                    .withCircuitBreakerErrorThresholdPercentage(<span class="number">50</span>)</span><br><span class="line">                                                    .withCircuitBreakerRequestVolumeThreshold(<span class="number">5</span>)</span><br><span class="line">                                                    .withMetricsRollingStatisticalWindowInMilliseconds(<span class="number">20000</span>)));</span><br><span class="line">        <span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ValueWrapper <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> delegate.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ValueWrapper <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.warn(<span class="string">"get fallback called, circuit is &#123;&#125;"</span>, <span class="keyword">super</span>.circuitBreaker.isOpen() ? <span class="string">"opened"</span> : <span class="string">"closed"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>20초간 API의 성공/실패 여부를 측정하며, 5번 이상 실행되고 50% 이상 실패했을 경우 회로가 열린다. Timeout은 500ms로 설정했다. <code>execute()</code>를 실행하면 <code>run()</code>이 실행되며, 실패한 경우 <code>getFallback()</code>이 실행된다.</p><h2 id="CacheConfig-1"><a href="#CacheConfig-1" class="headerlink" title="CacheConfig"></a>CacheConfig</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span>(proxyTargetClass = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheConfig</span> <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">redisCacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RedisCacheManager.RedisCacheManagerBuilder builder = RedisCacheManager.RedisCacheManagerBuilder.fromConnectionFactory(jedisConnectionFactory());</span><br><span class="line"></span><br><span class="line">        RedisCacheConfiguration defaultConfig =</span><br><span class="line">                RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">                                       .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="keyword">new</span> GenericJackson2JsonRedisSerializer()))</span><br><span class="line">                                       .entryTtl(Duration.ofSeconds(<span class="number">20L</span>));</span><br><span class="line"></span><br><span class="line">        builder.cacheDefaults(defaultConfig);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HystrixCacheManager(<span class="keyword">new</span> LoggingCacheManager(builder.build(), <span class="string">"Global-Cache"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>앞서 만들었던 부분을 그대로 생성자로 주입하자.</p><h2 id="테스트-2"><a href="#테스트-2" class="headerlink" title="테스트"></a>테스트</h2><p>서버를 실행 후 Redis 서버를 Down 시킨 후 <code>/people/1</code>을 호출해보았다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">2018-04-18 22:55:09.653  INFO LoggingCache           : Local-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:09.653  INFO LoggingCache           : Global-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:09.661  WARN HystrixCacheGetCommand : get fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:09.662  INFO PersonService          : get(Long) called</span><br><span class="line">2018-04-18 22:55:09.662  INFO LoggingCache           : Local-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:09.663  INFO LoggingCache           : Global-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:10.164  WARN HystrixCachePutCommand : put fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:14.085  INFO LoggingCache           : Local-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:14.086  INFO LoggingCache           : Global-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:14.588  WARN HystrixCacheGetCommand : get fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:14.588  INFO PersonService          : get(Long) called</span><br><span class="line">2018-04-18 22:55:14.588  INFO LoggingCache           : Local-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:14.588  INFO LoggingCache           : Global-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:15.090  WARN HystrixCachePutCommand : put fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:16.104  INFO LoggingCache           : Local-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:16.105  INFO LoggingCache           : Global-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:16.606  WARN HystrixCacheGetCommand : get fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:16.606  INFO PersonService          : get(Long) called</span><br><span class="line">2018-04-18 22:55:16.606  INFO LoggingCache           : Local-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:16.607  INFO LoggingCache           : Global-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:17.108  WARN HystrixCachePutCommand : put fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:17.973  INFO LoggingCache           : Local-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:17.974  INFO LoggingCache           : Global-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:18.474  WARN HystrixCacheGetCommand : get fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:18.474  INFO PersonService          : get(Long) called</span><br><span class="line">2018-04-18 22:55:18.474  INFO LoggingCache           : Local-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:18.475  INFO LoggingCache           : Global-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:18.977  WARN HystrixCachePutCommand : put fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:19.112  INFO LoggingCache           : Local-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:19.112  INFO LoggingCache           : Global-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:19.613  WARN HystrixCacheGetCommand : get fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:19.613  INFO PersonService          : get(Long) called</span><br><span class="line">2018-04-18 22:55:19.613  INFO LoggingCache           : Local-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:19.614  INFO LoggingCache           : Global-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:20.114  WARN HystrixCachePutCommand : put fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:20.241  INFO LoggingCache           : Local-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:20.241  INFO LoggingCache           : Global-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:20.742  WARN HystrixCacheGetCommand : get fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:20.742  INFO PersonService          : get(Long) called</span><br><span class="line">2018-04-18 22:55:20.743  INFO LoggingCache           : Local-Cache.put(Object, Object) called</span><br><span class="line"></span><br><span class="line"># 일정 횟수 fallback이 호출된 후 회로 열림!</span><br><span class="line">2018-04-18 22:55:20.743  WARN HystrixCachePutCommand : put fallback called, circuit is opened</span><br><span class="line">2018-04-18 22:55:21.312  INFO LoggingCache           : Local-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:21.312  WARN HystrixCacheGetCommand : get fallback called, circuit is opened</span><br><span class="line">2018-04-18 22:55:21.312  INFO PersonService          : get(Long) called</span><br><span class="line">2018-04-18 22:55:21.312  INFO LoggingCache           : Local-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:21.312  WARN HystrixCachePutCommand : put fallback called, circuit is opened</span><br><span class="line">2018-04-18 22:55:22.250  INFO LoggingCache           : Local-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:22.250  WARN HystrixCacheGetCommand : get fallback called, circuit is opened</span><br></pre></td></tr></table></figure><blockquote><p>소스코드 : <a href="https://github.com/supawer0728/simple-cache/tree/hystrix-cache" target="_blank" rel="noopener">https://github.com/supawer0728/simple-cache/tree/hystrix-cache</a></p></blockquote><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p>Spring의 캐시 추상화를 사용하며, 부하 분산을 통해 장애에 대응할 수 있는 방안에 대해 다뤄보았다.</p><p>우선 n차 캐시 구성을 통해서 Heap을 사용하여 외부 시스템의 호출을 줄여서 전역 리소스(전역 캐시, repository)의 부하를 줄였다. n차 캐시 구성을 사용하는 경우, 리소스 간의 일관성이 무너질 수 있다. 일관성이 중요할수록 로컬 캐시의 수명을 짧게해서 사용해야 한다. </p><p>원격 캐시의 경우 파티션(장애)이 발생할 수 있다. 이에 대응하기 위해 Hystrix를 활용할 수 있다. 회로를 열어 원격에 요청을 보내지 않고, 빠른 실패처리를 할 수 있다. 하지만 여기서도 유의해야할 점이 있는데. 트래픽이 몰리는 상황에서 부하를 견디지 못해 장애가 발생한 경우, 이를 1차 캐시와 repository가 받아내게 된다. 본문에서는 fallback에서 null을 던져 repository를 실행시켰다. 원격 캐시에서 장애가 발생했을 때, 사용자 정의 Exception을 던져 캐시 오류인 경우의 응답을 따로 내려줘서 repository를 지켜내는 것도 방법이 될 수 있을 것 같다.</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;Spring은 &lt;a href=&quot;https://docs.spring.io/spring/docs/5.0.5.RELEASE/spring-framework-reference/integration.html#cache&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;캐시 추상화&lt;/a&gt;를 통해서 쉽게 캐시를 사용할 수 있게 해준다. &lt;code&gt;CacheManager&lt;/code&gt;를 잘 구현한다면 &lt;code&gt;@Cacheable&lt;/code&gt;, &lt;code&gt;@CachePut&lt;/code&gt;, &lt;code&gt;@CacheEvict&lt;/code&gt; 등을 통해서 얼마든지 커스터마이징된 캐시를 사용할 수 있다. 하지만 의외로 장애에 대응하는 방안에 대해서는 Reference 상에서도 구체적인 설명을 해주지 않고 있다. 덕분에 다시 글 쓸 거리가 생긴 것 같다.&lt;/p&gt;
&lt;p&gt;사용하는 캐시 시스템에 문제가 생겼을 때 어떻게 대처해야하는지는 어떤 정보를 캐시하느냐에 따라 다르다. 경우의 수 자체가 너무 많다. 또한 캐시 자체가 여러 용도로 쓰일 수 있다. HTTP 응답을 캐시하든지, Repository의 결과를 캐시하든지 혹은 Service의 결과를 캐시할 수도 있다. 본문에서는 아래 두 경우로 간단하게 나누고 